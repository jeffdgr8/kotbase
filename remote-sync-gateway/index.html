
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Kotlin Multiplatform library for Couchbase Liteâ€”a lightweight, embedded, syncable, NoSQL database">
      
      
        <meta name="author" content="Jeff Lockhart">
      
      
        <link rel="canonical" href="https://kotbase.dev/remote-sync-gateway/">
      
      
        <link rel="prev" href="../indexing/">
      
      
        <link rel="next" href="../intra-device-sync/">
      
      
      <link rel="icon" href="../assets/images/couchbase-logo.svg">
      <meta name="generator" content="mkdocs-1.5.3, mkdocs-material-9.4.6">
    
    
      
        <title>Remote Sync Gateway - Kotbase</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.35e1ed30.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.356b1318.min.css">
      
      
  
  
    
    
  
    
    
  
  
  <style>:root{--md-admonition-icon--link:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1M8 13h8v-2H8v2m9-6h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1 0 1.71-1.39 3.1-3.1 3.1h-4V17h4a5 5 0 0 0 5-5 5 5 0 0 0-5-5Z"/></svg>');--md-admonition-icon--important:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 6a6 6 0 0 1 6 6c0 2.22-1.21 4.16-3 5.2V19a1 1 0 0 1-1 1h-4a1 1 0 0 1-1-1v-1.8c-1.79-1.04-3-2.98-3-5.2a6 6 0 0 1 6-6m2 15v1a1 1 0 0 1-1 1h-2a1 1 0 0 1-1-1v-1h4m6-10h3v2h-3v-2M1 11h3v2H1v-2M13 1v3h-2V1h2M4.92 3.5l2.13 2.14-1.42 1.41L3.5 4.93 4.92 3.5m12.03 2.13 2.12-2.13 1.43 1.43-2.13 2.12-1.42-1.42Z"/></svg>');}</style>



    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=DM+Sans:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"DM Sans";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/permalink.css">
    
      <link rel="stylesheet" href="../assets/stylesheets/extra.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  
  

<script id="__analytics">function __md_analytics(){function n(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],n("js",new Date),n("config","G-QFS8SG5ZKD"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){this.value&&n("event","search",{search_term:this.value})}),document$.subscribe(function(){var a=document.forms.feedback;if(void 0!==a)for(var e of a.querySelectorAll("[type=submit]"))e.addEventListener("click",function(e){e.preventDefault();var t=document.location.pathname,e=this.getAttribute("data-md-value");n("event","feedback",{page:t,data:e}),a.firstElementChild.disabled=!0;e=a.querySelector(".md-feedback__note [data-md-value='"+e+"']");e&&(e.hidden=!1)}),a.hidden=!1}),location$.subscribe(function(e){n("config","G-QFS8SG5ZKD",{page_path:e.pathname})})});var e=document.createElement("script");e.async=!0,e.src="https://www.googletagmanager.com/gtag/js?id=G-QFS8SG5ZKD",document.getElementById("__analytics").insertAdjacentElement("afterEnd",e)}</script>
  
    <script>"undefined"!=typeof __md_analytics&&__md_analytics()</script>
  

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="white" data-md-color-accent="red">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#introduction" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <div data-md-color-scheme="default" data-md-component="outdated" hidden>
        
      </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Kotbase" class="md-header__button md-logo" aria-label="Kotbase" data-md-component="logo">
      
  <img src="../assets/images/couchbase-logo.svg" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Kotbase
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Remote Sync Gateway
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="white" data-md-color-accent="red"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="black" data-md-color-accent="red"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_2">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12c0-2.42-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg>
      </label>
    
  
</form>
      
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/jeffdgr8/kotbase" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    Kotbase
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href=".." class="md-tabs__link">
          
  
  Overview

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../installation/" class="md-tabs__link">
          
  
  Getting Started

        </a>
      </li>
    
  

      
        
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../databases/" class="md-tabs__link">
          
  
  Documentation

        </a>
      </li>
    
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../api" target="_blank" class="md-tabs__link">
        
  
    
  
  API Reference

      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Kotbase" class="md-nav__button md-logo" aria-label="Kotbase" data-md-component="logo">
      
  <img src="../assets/images/couchbase-logo.svg" alt="logo">

    </a>
    Kotbase
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/jeffdgr8/kotbase" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    Kotbase
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
    
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1" >
        
          
          <label class="md-nav__link" for="__nav_1" id="__nav_1_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Overview
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_1">
            <span class="md-nav__icon md-icon"></span>
            Overview
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Kotbase
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../differences/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Differences from Java SDK
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../roadmap/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Roadmap
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../community/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Community
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../license/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    License
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
    
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Getting Started
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Getting Started
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../installation/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Installation
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../platforms/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Supported Platforms
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../getting-started/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Build and Run
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_4" >
        
          
          <label class="md-nav__link" for="__nav_2_4" id="__nav_2_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Extension Libraries
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_4">
            <span class="md-nav__icon md-icon"></span>
            Extension Libraries
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../ktx/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    KTX
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../kermit/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Kermit
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../paging/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Paging
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
    
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" checked>
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Documentation
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Documentation
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../databases/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Databases
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../prebuilt-database/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Pre-built Database
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../documents/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Documents
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../blobs/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Blobs
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_5" >
        
          
          <label class="md-nav__link" for="__nav_3_5" id="__nav_3_5_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Query
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_5">
            <span class="md-nav__icon md-icon"></span>
            Query
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../query-builder/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    QueryBuilder
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../n1ql-query-strings/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    SQL++ Query Strings
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../n1ql-server-differences/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    SQL++ Server Differences
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../n1ql-query-builder-differences/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    SQL++ QueryBuilder Differences
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../query-result-sets/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Query Result Sets
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../live-queries/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Live Queries
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../query-troubleshooting/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Query Troubleshooting
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../full-text-search/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Full Text Search
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../indexing/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Indexing
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_8" checked>
        
          
          <label class="md-nav__link" for="__nav_3_8" id="__nav_3_8_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Data Sync
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_8_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3_8">
            <span class="md-nav__icon md-icon"></span>
            Data Sync
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Remote Sync Gateway
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Remote Sync Gateway
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#introduction" class="md-nav__link">
    Introduction
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#replication-protocol" class="md-nav__link">
    Replication Protocol
  </a>
  
    <nav class="md-nav" aria-label="Replication Protocol">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#scheme" class="md-nav__link">
    Scheme
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ordering" class="md-nav__link">
    Ordering
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#configuration-summary" class="md-nav__link">
    Configuration Summary
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#configure" class="md-nav__link">
    Configure
  </a>
  
    <nav class="md-nav" aria-label="Configure">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#configure-target" class="md-nav__link">
    Configure Target
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sync-mode" class="md-nav__link">
    Sync Mode
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#retry-configuration" class="md-nav__link">
    Retry Configuration
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#user-authorization" class="md-nav__link">
    User Authorization
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#server-authentication" class="md-nav__link">
    Server Authentication
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#client-authentication" class="md-nav__link">
    Client Authentication
  </a>
  
    <nav class="md-nav" aria-label="Client Authentication">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#basic-authentication" class="md-nav__link">
    Basic Authentication
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#session-authentication" class="md-nav__link">
    Session Authentication
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#custom-headers" class="md-nav__link">
    Custom Headers
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#replication-filters" class="md-nav__link">
    Replication Filters
  </a>
  
    <nav class="md-nav" aria-label="Replication Filters">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#push-filter" class="md-nav__link">
    Push Filter
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pull-filter" class="md-nav__link">
    Pull Filter
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#channels" class="md-nav__link">
    Channels
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#auto-purge-on-channel-access-revocation" class="md-nav__link">
    Auto-purge on Channel Access Revocation
  </a>
  
    <nav class="md-nav" aria-label="Auto-purge on Channel Access Revocation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#new-outcome" class="md-nav__link">
    New outcome
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#prior-outcome" class="md-nav__link">
    Prior outcome
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#behavior" class="md-nav__link">
    Behavior
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#config" class="md-nav__link">
    Config
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#overrides" class="md-nav__link">
    Overrides
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delta-sync" class="md-nav__link">
    Delta Sync
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#initialize" class="md-nav__link">
    Initialize
  </a>
  
    <nav class="md-nav" aria-label="Initialize">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#start-replicator" class="md-nav__link">
    Start Replicator
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#checkpoint-starts" class="md-nav__link">
    Checkpoint Starts
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#monitor" class="md-nav__link">
    Monitor
  </a>
  
    <nav class="md-nav" aria-label="Monitor">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#change-listeners" class="md-nav__link">
    Change Listeners
  </a>
  
    <nav class="md-nav" aria-label="Change Listeners">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#using-kotlin-flows" class="md-nav__link">
    Using Kotlin Flows
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#replicator-status" class="md-nav__link">
    Replicator Status
  </a>
  
    <nav class="md-nav" aria-label="Replicator Status">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#replication-states" class="md-nav__link">
    Replication States
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#replication-status-and-app-life-cycle" class="md-nav__link">
    Replication Status and App Life Cycle
  </a>
  
    <nav class="md-nav" aria-label="Replication Status and App Life Cycle">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ios" class="md-nav__link">
    iOS
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#other-platforms" class="md-nav__link">
    Other Platforms
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#monitor-document-changes" class="md-nav__link">
    Monitor Document Changes
  </a>
  
    <nav class="md-nav" aria-label="Monitor Document Changes">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#document-access-removal-behavior" class="md-nav__link">
    Document Access Removal Behavior
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#documents-pending-push" class="md-nav__link">
    Documents Pending Push
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#stop" class="md-nav__link">
    Stop
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#error-handling" class="md-nav__link">
    Error Handling
  </a>
  
    <nav class="md-nav" aria-label="Error Handling">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#using-kotlin-flows_1" class="md-nav__link">
    Using Kotlin Flows
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#load-balancers" class="md-nav__link">
    Load Balancers
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#certificate-pinning" class="md-nav__link">
    Certificate Pinning
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#troubleshooting" class="md-nav__link">
    Troubleshooting
  </a>
  
    <nav class="md-nav" aria-label="Troubleshooting">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#logs" class="md-nav__link">
    Logs
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#authentication-errors" class="md-nav__link">
    Authentication Errors
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../intra-device-sync/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Intra-device Sync
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_8_3" >
        
          
          <label class="md-nav__link" for="__nav_3_8_3" id="__nav_3_8_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Peer-to-Peer
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_3_8_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_8_3">
            <span class="md-nav__icon md-icon"></span>
            Peer-to-Peer
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../peer-to-peer-sync/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Peer-to-Peer Sync
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../passive-peer/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Passive Peer
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../active-peer/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Active Peer
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../integrate-custom-listener/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Integrate Custom Listener
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../handling-data-conflicts/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Handling Data Conflicts
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../using-logs/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Using Logs
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../kotlin-extensions/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Kotlin Extensions
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../api" target="_blank" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    API Reference
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#introduction" class="md-nav__link">
    Introduction
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#replication-protocol" class="md-nav__link">
    Replication Protocol
  </a>
  
    <nav class="md-nav" aria-label="Replication Protocol">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#scheme" class="md-nav__link">
    Scheme
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ordering" class="md-nav__link">
    Ordering
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#configuration-summary" class="md-nav__link">
    Configuration Summary
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#configure" class="md-nav__link">
    Configure
  </a>
  
    <nav class="md-nav" aria-label="Configure">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#configure-target" class="md-nav__link">
    Configure Target
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sync-mode" class="md-nav__link">
    Sync Mode
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#retry-configuration" class="md-nav__link">
    Retry Configuration
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#user-authorization" class="md-nav__link">
    User Authorization
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#server-authentication" class="md-nav__link">
    Server Authentication
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#client-authentication" class="md-nav__link">
    Client Authentication
  </a>
  
    <nav class="md-nav" aria-label="Client Authentication">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#basic-authentication" class="md-nav__link">
    Basic Authentication
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#session-authentication" class="md-nav__link">
    Session Authentication
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#custom-headers" class="md-nav__link">
    Custom Headers
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#replication-filters" class="md-nav__link">
    Replication Filters
  </a>
  
    <nav class="md-nav" aria-label="Replication Filters">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#push-filter" class="md-nav__link">
    Push Filter
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pull-filter" class="md-nav__link">
    Pull Filter
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#channels" class="md-nav__link">
    Channels
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#auto-purge-on-channel-access-revocation" class="md-nav__link">
    Auto-purge on Channel Access Revocation
  </a>
  
    <nav class="md-nav" aria-label="Auto-purge on Channel Access Revocation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#new-outcome" class="md-nav__link">
    New outcome
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#prior-outcome" class="md-nav__link">
    Prior outcome
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#behavior" class="md-nav__link">
    Behavior
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#config" class="md-nav__link">
    Config
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#overrides" class="md-nav__link">
    Overrides
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delta-sync" class="md-nav__link">
    Delta Sync
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#initialize" class="md-nav__link">
    Initialize
  </a>
  
    <nav class="md-nav" aria-label="Initialize">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#start-replicator" class="md-nav__link">
    Start Replicator
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#checkpoint-starts" class="md-nav__link">
    Checkpoint Starts
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#monitor" class="md-nav__link">
    Monitor
  </a>
  
    <nav class="md-nav" aria-label="Monitor">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#change-listeners" class="md-nav__link">
    Change Listeners
  </a>
  
    <nav class="md-nav" aria-label="Change Listeners">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#using-kotlin-flows" class="md-nav__link">
    Using Kotlin Flows
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#replicator-status" class="md-nav__link">
    Replicator Status
  </a>
  
    <nav class="md-nav" aria-label="Replicator Status">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#replication-states" class="md-nav__link">
    Replication States
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#replication-status-and-app-life-cycle" class="md-nav__link">
    Replication Status and App Life Cycle
  </a>
  
    <nav class="md-nav" aria-label="Replication Status and App Life Cycle">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ios" class="md-nav__link">
    iOS
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#other-platforms" class="md-nav__link">
    Other Platforms
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#monitor-document-changes" class="md-nav__link">
    Monitor Document Changes
  </a>
  
    <nav class="md-nav" aria-label="Monitor Document Changes">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#document-access-removal-behavior" class="md-nav__link">
    Document Access Removal Behavior
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#documents-pending-push" class="md-nav__link">
    Documents Pending Push
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#stop" class="md-nav__link">
    Stop
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#error-handling" class="md-nav__link">
    Error Handling
  </a>
  
    <nav class="md-nav" aria-label="Error Handling">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#using-kotlin-flows_1" class="md-nav__link">
    Using Kotlin Flows
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#load-balancers" class="md-nav__link">
    Load Balancers
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#certificate-pinning" class="md-nav__link">
    Certificate Pinning
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#troubleshooting" class="md-nav__link">
    Troubleshooting
  </a>
  
    <nav class="md-nav" aria-label="Troubleshooting">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#logs" class="md-nav__link">
    Logs
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#authentication-errors" class="md-nav__link">
    Authentication Errors
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


  <h1>Remote Sync Gateway</h1>

<p><em>Couchbase Lite â€” Synchronizing data changes between local and remote databases using Sync Gateway</em></p>
<div class="admonition warning">
<p class="admonition-title">Android enablers</p>
<p><strong>Allow Unencrypted Network Traffic</strong></p>
<p>To use cleartext, un-encrypted, network traffic (<code>http://</code> and-or <code>ws://</code>), include
<code>android:usesCleartextTraffic="true"</code> in the <code>application</code> element of the manifest as shown on
<a href="https://developer.android.com/training/articles/security-config#CleartextTrafficPermitted">developer.android.com</a>.<br />
<strong>This not recommended in production.</strong></p>
</div>
<div class="admonition warning">
<p class="admonition-title">Use Background Threads</p>
<p>As with any network or file I/O activity, Couchbase Lite activities should not be performed on the UI thread.
<strong>Always</strong> use a <strong>background</strong> thread.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Code Snippets</p>
<p>All code examples are indicative only. They demonstrate the basic concepts and approaches to using a feature. Use
them as inspiration and adapt these examples to best practice when developing applications for your platform.</p>
</div>
<h2 id="introduction">Introduction<a class="headerlink" href="#introduction" title="Permanent link"></a></h2>
<p>Couchbase Lite provides API support for secure, bi-directional, synchronization of data changes between mobile
applications and a central server database. It does so by using a <em>replicator</em> to interact with Sync Gateway.</p>
<p>The <em>replicator</em> is designed to manage replication of documents and-or document changes between a source and a target
database. For example, between a local Couchbase Lite database and remote Sync Gateway database, which is ultimately
mapped to a bucket in a Couchbase Server instance in the cloud or on a server.</p>
<p>This page shows sample code and configuration examples covering the implementation of a replication using Sync Gateway.</p>
<p>Your application runs a replicator (also referred to here as a client), which will initiate connection with a Sync
Gateway (also referred to here as a server) and participate in the replication of database changes to bring both local
and remote databases into sync.</p>
<p>Subsequent sections provide additional details and examples for the main configuration options.</p>
<h2 id="replication-protocol">Replication Protocol<a class="headerlink" href="#replication-protocol" title="Permanent link"></a></h2>
<h3 id="scheme">Scheme<a class="headerlink" href="#scheme" title="Permanent link"></a></h3>
<p>Couchbase Mobile uses a replication protocol based on WebSockets for replication. To use this protocol the replication
URL should specify WebSockets as the URL scheme (see the <a href="#configure-target">Configure Target</a> section below).</p>
<h3 id="ordering">Ordering<a class="headerlink" href="#ordering" title="Permanent link"></a></h3>
<p>To optimize for speed, the replication protocol doesnâ€™t guarantee that documents will be received in a particular order.
So we donâ€™t recommend to rely on that when using the replication or database change listeners for example.</p>
<h2 id="configuration-summary">Configuration Summary<a class="headerlink" href="#configuration-summary" title="Permanent link"></a></h2>
<p>You should configure and initialize a replicator for each Couchbase Lite database instance you want to sync. <a href="#example-1">Example
1</a> shows the configuration and initialization process.</p>
<div class="admonition example">
<p class="admonition-title"><span id='example-1'>Example 1. Replication configuration and initialization</span></p>
<div class="language-kotlin highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="kd">val</span><span class="w"> </span><span class="nv">repl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Replicator</span><span class="p">(</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a><span class="w">    </span><span class="c1">// initialize the replicator configuration</span>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="w">    </span><span class="n">ReplicatorConfigurationFactory</span><span class="p">.</span><span class="na">newConfig</span><span class="p">(</span>
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="w">        </span><span class="n">database</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">database</span><span class="p">,</span>
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="w">        </span><span class="n">target</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">URLEndpoint</span><span class="p">(</span><span class="n">URI</span><span class="p">(</span><span class="s">&quot;wss://listener.com:8954&quot;</span><span class="p">)),</span><span class="w"> </span>
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="w">        </span><span class="c1">// Set replicator type</span>
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a><span class="w">        </span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ReplicatorType</span><span class="p">.</span><span class="na">PUSH_AND_PULL</span><span class="p">,</span>
</span><span id="__span-0-9"><a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>
</span><span id="__span-0-10"><a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a><span class="w">        </span><span class="c1">// Configure Sync Mode</span>
</span><span id="__span-0-11"><a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a><span class="w">        </span><span class="n">continuous</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="c1">// default value</span>
</span><span id="__span-0-12"><a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>
</span><span id="__span-0-13"><a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a><span class="w">        </span><span class="c1">// set auto-purge behavior</span>
</span><span id="__span-0-14"><a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a><span class="w">        </span><span class="c1">// (here we override default)</span>
</span><span id="__span-0-15"><a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a><span class="w">        </span><span class="n">enableAutoPurge</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span>
</span><span id="__span-0-16"><a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>
</span><span id="__span-0-17"><a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a><span class="w">        </span><span class="c1">// Configure Server Authentication --</span>
</span><span id="__span-0-18"><a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a><span class="w">        </span><span class="c1">// only accept self-signed certs</span>
</span><span id="__span-0-19"><a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a><span class="w">        </span><span class="n">acceptOnlySelfSignedServerCertificate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span>
</span><span id="__span-0-20"><a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a>
</span><span id="__span-0-21"><a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a><span class="w">        </span><span class="c1">// Configure the credentials the</span>
</span><span id="__span-0-22"><a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a><span class="w">        </span><span class="c1">// client will provide if prompted</span>
</span><span id="__span-0-23"><a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a><span class="w">        </span><span class="n">authenticator</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BasicAuthenticator</span><span class="p">(</span><span class="s">&quot;PRIVUSER&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;let me in&quot;</span><span class="p">.</span><span class="na">toCharArray</span><span class="p">()),</span><span class="w"> </span>
</span><span id="__span-0-24"><a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a>
</span><span id="__span-0-25"><a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a><span class="w">        </span><span class="cm">/* Optionally set custom conflict resolver call back */</span>
</span><span id="__span-0-26"><a id="__codelineno-0-26" name="__codelineno-0-26" href="#__codelineno-0-26"></a><span class="w">        </span><span class="n">conflictResolver</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span>
</span><span id="__span-0-27"><a id="__codelineno-0-27" name="__codelineno-0-27" href="#__codelineno-0-27"></a><span class="w">    </span><span class="p">)</span>
</span><span id="__span-0-28"><a id="__codelineno-0-28" name="__codelineno-0-28" href="#__codelineno-0-28"></a><span class="p">)</span>
</span><span id="__span-0-29"><a id="__codelineno-0-29" name="__codelineno-0-29" href="#__codelineno-0-29"></a>
</span><span id="__span-0-30"><a id="__codelineno-0-30" name="__codelineno-0-30" href="#__codelineno-0-30"></a><span class="c1">// Optionally add a change listener </span>
</span><span id="__span-0-31"><a id="__codelineno-0-31" name="__codelineno-0-31" href="#__codelineno-0-31"></a><span class="kd">val</span><span class="w"> </span><span class="nv">token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">repl</span><span class="p">.</span><span class="na">addChangeListener</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">change</span><span class="w"> </span><span class="o">-&gt;</span>
</span><span id="__span-0-32"><a id="__codelineno-0-32" name="__codelineno-0-32" href="#__codelineno-0-32"></a><span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">err</span><span class="p">:</span><span class="w"> </span><span class="n">CouchbaseLiteException? </span><span class="o">=</span><span class="w"> </span><span class="n">change</span><span class="p">.</span><span class="na">status</span><span class="p">.</span><span class="na">error</span>
</span><span id="__span-0-33"><a id="__codelineno-0-33" name="__codelineno-0-33" href="#__codelineno-0-33"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-0-34"><a id="__codelineno-0-34" name="__codelineno-0-34" href="#__codelineno-0-34"></a><span class="w">        </span><span class="n">println</span><span class="p">(</span><span class="s">&quot;Error code :: </span><span class="si">${</span><span class="n">err</span><span class="p">.</span><span class="na">code</span><span class="si">}</span><span class="s">\n</span><span class="si">$</span><span class="n">err</span><span class="s">&quot;</span><span class="p">)</span>
</span><span id="__span-0-35"><a id="__codelineno-0-35" name="__codelineno-0-35" href="#__codelineno-0-35"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-0-36"><a id="__codelineno-0-36" name="__codelineno-0-36" href="#__codelineno-0-36"></a><span class="p">}</span>
</span><span id="__span-0-37"><a id="__codelineno-0-37" name="__codelineno-0-37" href="#__codelineno-0-37"></a>
</span><span id="__span-0-38"><a id="__codelineno-0-38" name="__codelineno-0-38" href="#__codelineno-0-38"></a><span class="c1">// Start replicator</span>
</span><span id="__span-0-39"><a id="__codelineno-0-39" name="__codelineno-0-39" href="#__codelineno-0-39"></a><span class="n">repl</span><span class="p">.</span><span class="na">start</span><span class="p">(</span><span class="kc">false</span><span class="p">)</span><span class="w"> </span>
</span><span id="__span-0-40"><a id="__codelineno-0-40" name="__codelineno-0-40" href="#__codelineno-0-40"></a>
</span><span id="__span-0-41"><a id="__codelineno-0-41" name="__codelineno-0-41" href="#__codelineno-0-41"></a><span class="k">this</span><span class="p">.</span><span class="na">replicator</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">repl</span>
</span><span id="__span-0-42"><a id="__codelineno-0-42" name="__codelineno-0-42" href="#__codelineno-0-42"></a><span class="k">this</span><span class="p">.</span><span class="na">token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">token</span>
</span></code></pre></div>
</div>
<p><strong>Notes on Example</strong></p>
<ol>
<li>Get endpoint for target database.</li>
<li>Use the <a href="/api/couchbase-lite-ee/kotbase/-replicator-configuration/"><code>ReplicatorConfiguration</code></a> classâ€™s constructor â€”
   <a href="/api/couchbase-lite-ee/kotbase/-replicator-configuration/-replicator-configuration.html"><code>ReplicatorConfiguration(Database, Endpoint)</code></a> â€” to initialize the
   replicator configuration with the local database â€” see also <a href="#configure-target">Configure Target</a>.</li>
<li>The default is to auto-purge documents that this user no longer has access to â€” see <a href="#auto-purge-on-channel-access-revocation">Auto-purge on Channel Access
   Revocation</a>. Here we override this behavior by setting its flag to false.</li>
<li>Configure how the client will authenticate the server. Here we say connect only to servers presenting a self-signed
   certificate. By default, clients accept only servers presenting certificates that can be verified using the OS
   bundled Root CA Certificates â€” see <a href="#server-authentication">Server Authentication</a>.</li>
<li>Configure the client-authentication credentials (if required). These are the credential the client will present to
   sync gateway if requested to do so.<br />
   Here we configure to provide <em>Basic Authentication</em> credentials. Other options are available â€” see <a href="#client-authentication">Client
   Authentication</a>.</li>
<li>Configure how the replication should handle conflict resolution â€” see <a href="../handling-data-conflicts/">Handling Data Conflicts</a> topic for mor on conflict resolution.</li>
<li>Initialize the replicator using your configuration â€” see <a href="#initialize">Initialize</a>.</li>
<li>Optionally, register an observer, which will notify you of changes to the replication status â€” see <a href="#monitor">Monitor
   </a>.</li>
<li>Start the replicator â€” see <a href="#start-replicator">Start Replicator</a>.</li>
</ol>
<h2 id="configure">Configure<a class="headerlink" href="#configure" title="Permanent link"></a></h2>
<p><strong>In this section</strong><br />
<a href="#configure-target">Configure Target</a> | <a href="#sync-mode">Sync Mode</a> | <a href="#retry-configuration">Retry Configuration</a> | <a href="#user-authorization">User
Authorization</a> | <a href="#server-authentication">Server Authentication</a> | <a href="#client-authentication">Client Authentication
</a> | <a href="#monitor-document-changes">Monitor Document Changes</a> | <a href="#custom-headers">Custom Headers</a> |
<a href="#checkpoint-starts">Checkpoint Starts</a> | <a href="#replication-filters">Replication Filters</a> | <a href="#channels">Channels</a> |
<a href="#auto-purge-on-channel-access-revocation">Auto-purge on Channel Access Revocation</a> | <a href="#delta-sync">Delta Sync</a></p>
<h3 id="configure-target">Configure Target<a class="headerlink" href="#configure-target" title="Permanent link"></a></h3>
<p>Use the Initialize and define the replication configuration with local and remote database locations using the
<a href="/api/couchbase-lite-ee/kotbase/-replicator-configuration/"><code>ReplicatorConfiguration</code></a> object.</p>
<p>The constructor provides:</p>
<ul>
<li>the name of the local database to be syncâ€™d</li>
<li>the serverâ€™s URL (including the port number and the name of the remote database to sync with)<br>
  <br>
  It is expected that the app will identify the IP address and URL and append the remote database name to the URL
  endpoint, producing for example: <code>wss://10.0.2.2:4984/travel-sample</code><br>
  <br>
  The URL scheme for web socket URLs uses <code>ws:</code> (non-TLS) or <code>wss:</code> (SSL/TLS) prefixes.<br>
  <br>
  On the Android platform, to use cleartext, un-encrypted, network traffic (<code>http://</code> and-or <code>ws://</code>), include
  <code>android:usesCleartextTraffic="true"</code> in the <code>application</code> element of the manifest as shown on <a href="https://developer.android.com/training/articles/security-config#CleartextTrafficPermitted">developer.android.com
  </a>.<br />
<strong>This not recommended in production.</strong></li>
</ul>
<div class="admonition example">
<p class="admonition-title">Example 2. Add Target to Configuration</p>
<div class="language-kotlin highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="c1">// initialize the replicator configuration</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a><span class="kd">val</span><span class="w"> </span><span class="nv">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ReplicatorConfiguration</span><span class="p">(</span>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a><span class="w">    </span><span class="n">database</span><span class="p">,</span>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a><span class="w">    </span><span class="n">URLEndpoint</span><span class="p">(</span><span class="s">&quot;wss://10.0.2.2:8954/travel-sample&quot;</span><span class="p">)</span>
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a><span class="p">)</span>
</span></code></pre></div>
<p>Note use of the scheme prefix (<code>wss://</code> to ensure TLS encryption â€” strongly recommended in production â€” or <code>ws://</code>)</p>
</div>
<h3 id="sync-mode">Sync Mode<a class="headerlink" href="#sync-mode" title="Permanent link"></a></h3>
<p>Here we define the direction and type of replication we want to initiate.</p>
<p>We use <a href="/api/couchbase-lite-ee/kotbase/-replicator-configuration/"><code>ReplicatorConfiguration</code></a> classâ€™s <a href="/api/couchbase-lite-ee/kotbase/-replicator-configuration/type.html"><code>type</code></a> and <a href="/api/couchbase-lite-ee/kotbase/-replicator-configuration/is-continuous.html"><code>isContinuous</code></a> parameters, to tell the replicator:</p>
<ul>
<li>The type (or direction) of the replication: <code>PUSH_AND_PULL</code>; <code>PULL</code>; <code>PUSH</code></li>
<li>The replication mode, that is either of:<ul>
<li>Continuous â€” remaining active indefinitely to replicate changed documents (<code>isContinuous=true</code>).</li>
<li>Ad-hoc â€” a one-shot replication of changed documents (<code>isContinuous=false</code>).</li>
</ul>
</li>
</ul>
<div class="admonition example">
<p class="admonition-title">Example 3. Configure replicator type and mode</p>
<div class="language-kotlin highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="c1">// Set replicator type</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ReplicatorType</span><span class="p">.</span><span class="na">PUSH_AND_PULL</span><span class="p">,</span>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a>
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a><span class="c1">// Configure Sync Mode</span>
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a><span class="n">continuous</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="c1">// default value</span>
</span></code></pre></div>
</div>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Unless there is a solid use-case not to, always initiate a single <code>PUSH_AND_PULL</code> replication rather than identical
separate <code>PUSH</code> and <code>PULL</code> replications.</p>
<p>This prevents the replications generating the same checkpoint <code>docID</code> resulting in multiple conflicts.</p>
</div>
<h3 id="retry-configuration">Retry Configuration<a class="headerlink" href="#retry-configuration" title="Permanent link"></a></h3>
<p>Couchbase Liteâ€™s replication retry logic assures a resilient connection.</p>
<p>The replicator minimizes the chance and impact of dropped connections by maintaining a heartbeat; essentially pinging
the Sync Gateway at a configurable interval to ensure the connection remains alive.</p>
<p>In the event it detects a transient error, the replicator will attempt to reconnect, stopping only when the connection
is re-established, or the number of retries exceeds the retry limit (9 times for a single-shot replication and unlimited
for a continuous replication).</p>
<p>On each retry the interval between attempts is increased exponentially (exponential backoff) up to the maximum wait time
limit (5 minutes).</p>
<p>The REST API provides configurable control over this replication retry logic using a set of configurable properties â€”
see <a href="#table-1">Table 1</a>.</p>
<p><strong>Table 1. Replication Retry Configuration Properties</strong></p>
<table>
<thead>
<tr>
<th style="text-align: left;"><div style="min-width:173px">Property</div></th>
<th style="text-align: left;">Use cases</th>
<th style="text-align: left;">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><a href="/api/couchbase-lite-ee/kotbase/-replicator-configuration/set-heartbeat.html"><code>setHeartbeat()</code></a></td>
<td style="text-align: left;"><ul><li>Reduce to detect connection errors sooner</li><li>Align to load-balancer or proxy <code>keep-alive</code> interval â€” see Sync Gatewayâ€™s topic <a href="https://docs.couchbase.com/sync-gateway/current/load-balancer.html#websocket-connection">Load Balancer - Keep Alive</a></li></ul></td>
<td style="text-align: left;">The interval (in seconds) between the heartbeat pulses.<br><br>Default: The replicator pings the Sync Gateway every 300 seconds.</td>
</tr>
<tr>
<td style="text-align: left;"><a href="/api/couchbase-lite-ee/kotbase/-replicator-configuration/set-max-attempts.html"><code>setMaxAttempts()</code></a></td>
<td style="text-align: left;">Change this to limit or extend the number of retry attempts.</td>
<td style="text-align: left;">The maximum number of retry attempts<ul><li>Set to zero (0) to use default values</li><li>Set to one (1) to prevent any retry attempt</li><li>The retry attempt count is reset when the replicator is able to connect and replicate</li><li>Default values are:<ul><li>Single-shot replication = 9;</li><li>Continuous replication = maximum integer value</li></ul></li><li>Negative values generate a Couchbase exception <code>InvalidArgumentException</code></li></ul></td>
</tr>
<tr>
<td style="text-align: left;"><a href="/api/couchbase-lite-ee/kotbase/-replicator-configuration/set-max-attempt-wait-time.html"><code>setMaxAttemptWaitTime()</code></a></td>
<td style="text-align: left;">Change this to adjust the interval between retries.</td>
<td style="text-align: left;">The maximum interval between retry attempts<br><br>While you can configure the <strong>maximum permitted</strong> wait time, the replicatorâ€™s exponential backoff algorithm calculates each individual interval which is not configurable.<ul><li>Default value: 300 seconds (5 minutes)</li><li>Zero sets the maximum interval between retries to the default of 300 seconds</li><li>300 sets the maximum interval between retries to the default of 300 seconds</li><li>A negative value generates a Couchbase exception, <code>InvalidArgumentException</code></li></ul></td>
</tr>
</tbody>
</table>
<p>When necessary you can adjust any or all of those configurable values â€” see <a href="#example-4">Example 4</a> for how to do this.</p>
<div class="admonition example">
<p class="admonition-title"><span id='example-4'>Example 4. Configuring Replication Retries</span></p>
<div class="language-kotlin highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="kd">val</span><span class="w"> </span><span class="nv">repl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Replicator</span><span class="p">(</span>
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a><span class="w">    </span><span class="n">ReplicatorConfigurationFactory</span><span class="p">.</span><span class="na">newConfig</span><span class="p">(</span>
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a><span class="w">        </span><span class="n">database</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">database</span><span class="p">,</span>
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a><span class="w">        </span><span class="n">target</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">URLEndpoint</span><span class="p">(</span><span class="s">&quot;ws://localhost:4984/mydatabase&quot;</span><span class="p">),</span>
</span><span id="__span-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a><span class="w">        </span><span class="c1">//  other config params as required . .</span>
</span><span id="__span-3-6"><a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a><span class="w">        </span><span class="n">heartbeat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">150</span><span class="p">,</span><span class="w"> </span>
</span><span id="__span-3-7"><a id="__codelineno-3-7" name="__codelineno-3-7" href="#__codelineno-3-7"></a><span class="w">        </span><span class="n">maxAttempts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">20</span><span class="p">,</span>
</span><span id="__span-3-8"><a id="__codelineno-3-8" name="__codelineno-3-8" href="#__codelineno-3-8"></a><span class="w">        </span><span class="n">maxAttemptWaitTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">600</span>
</span><span id="__span-3-9"><a id="__codelineno-3-9" name="__codelineno-3-9" href="#__codelineno-3-9"></a><span class="w">    </span><span class="p">)</span>
</span><span id="__span-3-10"><a id="__codelineno-3-10" name="__codelineno-3-10" href="#__codelineno-3-10"></a><span class="p">)</span>
</span><span id="__span-3-11"><a id="__codelineno-3-11" name="__codelineno-3-11" href="#__codelineno-3-11"></a><span class="n">repl</span><span class="p">.</span><span class="na">start</span><span class="p">()</span>
</span><span id="__span-3-12"><a id="__codelineno-3-12" name="__codelineno-3-12" href="#__codelineno-3-12"></a><span class="k">this</span><span class="p">.</span><span class="na">replicator</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">repl</span>
</span></code></pre></div>
</div>
<h3 id="user-authorization">User Authorization<a class="headerlink" href="#user-authorization" title="Permanent link"></a></h3>
<p>By default, Sync Gateway does not enable user authorization. This makes it easier to get up and running with
synchronization.</p>
<p>You can enable authorization in the sync gateway configuration file, as shown in <a href="#example-5">Example 5</a>.</p>
<div class="admonition example">
<p class="admonition-title"><span id='example-5'>Example 5. Enable Authorization</span></p>
<div class="language-json highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="p">{</span>
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a><span class="w">  </span><span class="nt">&quot;databases&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a><span class="w">    </span><span class="nt">&quot;mydatabase&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a><span class="w">      </span><span class="nt">&quot;users&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-4-5"><a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a><span class="w">        </span><span class="nt">&quot;GUEST&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nt">&quot;disabled&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-4-6"><a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a><span class="w">      </span><span class="p">}</span>
</span><span id="__span-4-7"><a id="__codelineno-4-7" name="__codelineno-4-7" href="#__codelineno-4-7"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-4-8"><a id="__codelineno-4-8" name="__codelineno-4-8" href="#__codelineno-4-8"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-4-9"><a id="__codelineno-4-9" name="__codelineno-4-9" href="#__codelineno-4-9"></a><span class="p">}</span>
</span></code></pre></div>
</div>
<p>To authorize with Sync Gateway, an associated user must first be created. Sync Gateway users can be created through the
<a href="https://docs.couchbase.com/sync-gateway/current/rest-api-admin.html#/Database_Security/post_db__user_"><code>POST /{db}/_user</code></a> endpoint on the
Admin REST API.</p>
<h3 id="server-authentication">Server Authentication<a class="headerlink" href="#server-authentication" title="Permanent link"></a></h3>
<p>Define the credentials your app (the client) is expecting to receive from the Sync Gateway (the server) in order to
ensure it is prepared to continue with the sync.</p>
<p>Note that the client cannot authenticate the server if TLS is turned off. When TLS is enabled (Sync Gatewayâ€™s default)
the client must authenticate the server. If the server cannot provide acceptable credentials then the connection will
fail.</p>
<p>Use <a href="/api/couchbase-lite-ee/kotbase/-replicator-configuration/"><code>ReplicatorConfiguration</code></a> properties
<a href="/api/couchbase-lite-ee/kotbase/set-accept-only-self-signed-server-certificate.html"><code>setAcceptOnlySelfSignedServerCertificate</code></a> and <a href="/api/couchbase-lite-ee/kotbase/-replicator-configuration/set-pinned-server-certificate.html"><code>setPinnedServerCertificate</code></a>, to tell the replicator how
to verify server-supplied TLS server certificates.</p>
<ul>
<li>If there is a pinned certificate, nothing else matters, the server cert must <strong>exactly</strong> match the pinned certificate.</li>
<li>If there are no pinned certs and <a href="/api/couchbase-lite-ee/kotbase/set-accept-only-self-signed-server-certificate.html"><code>setAcceptOnlySelfSignedServerCertificate</code></a> is <code>true</code> then any self-signed
  certificate is accepted. Certificates that are not self-signed are rejected, no matter who signed them.</li>
<li>If there are no pinned certificates and <a href="/api/couchbase-lite-ee/kotbase/set-accept-only-self-signed-server-certificate.html"><code>setAcceptOnlySelfSignedServerCertificate</code></a> is <code>false</code> (default), the client
  validates the serverâ€™s certificates against the system CA certificates. The server must supply a chain of certificates
  whose root is signed by one of the certificates in the system CA bundle.</li>
</ul>
<div class="admonition example">
<p class="admonition-title">Example 6. Set Server TLS security</p>
<div class="tabbed-set tabbed-alternate" data-tabs="1:3"><input checked="checked" id="__tabbed_1_1" name="__tabbed_1" type="radio" /><input id="__tabbed_1_2" name="__tabbed_1" type="radio" /><input id="__tabbed_1_3" name="__tabbed_1" type="radio" /><div class="tabbed-labels"><label for="__tabbed_1_1">CA Cert</label><label for="__tabbed_1_2">Self-Signed Cert</label><label for="__tabbed_1_3">Pinned Certificate</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p>Set the client to expect and accept only CA attested certificates.</p>
<div class="language-kotlin highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="c1">// Configure Server Security</span>
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a><span class="c1">// -- only accept CA attested certs</span>
</span><span id="__span-5-3"><a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a><span class="n">acceptOnlySelfSignedServerCertificate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span>
</span></code></pre></div>
<p>This is the default. Only certificate chains with roots signed by a trusted CA are allowed. Self-signed
certificates are not allowed.</p>
</div>
<div class="tabbed-block">
<p>Set the client to expect and accept only self-signed certificates.</p>
<div class="language-kotlin highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="c1">// Configure Server Authentication --</span>
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a><span class="c1">// only accept self-signed certs</span>
</span><span id="__span-6-3"><a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a><span class="n">acceptOnlySelfSignedServerCertificate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
</span></code></pre></div>
<p>Set this to <code>true</code> to accept any self-signed cert. Any certificates that are not self-signed are rejected.</p>
</div>
<div class="tabbed-block">
<p>Set the client to expect and accept only a pinned certificate.</p>
<div class="language-kotlin highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="c1">// Use the pinned certificate from the byte array (cert)</span>
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a><span class="n">pinnedServerCertificate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TLSIdentity</span><span class="p">.</span><span class="na">getIdentity</span><span class="p">(</span><span class="s">&quot;Our Corporate Id&quot;</span><span class="p">)</span>
</span><span id="__span-7-3"><a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a><span class="w">    </span><span class="o">?.</span><span class="na">certs</span><span class="o">?.</span><span class="na">firstOrNull</span><span class="p">()</span>
</span><span id="__span-7-4"><a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a><span class="w">    </span><span class="o">?:</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="n">IllegalStateException</span><span class="p">(</span><span class="s">&quot;Cannot find corporate id&quot;</span><span class="p">),</span>
</span></code></pre></div>
<p>Configure the pinned certificate using data from the byte array <code>cert</code></p>
</div>
</div>
</div>
</div>
<p>This all assumes that you have configured the Sync Gateway to provide the appropriate SSL certificates, and have
included the appropriate certificate in your app bundle â€” for more on this see <a href="#certificate-pinning">Certificate Pinning
</a>.</p>
<h3 id="client-authentication">Client Authentication<a class="headerlink" href="#client-authentication" title="Permanent link"></a></h3>
<p>There are two ways to authenticate from a Couchbase Lite client: <a href="#basic-authentication">Basic Authentication</a> or
<a href="#session-authentication">Session Authentication</a>.</p>
<h4 id="basic-authentication">Basic Authentication<a class="headerlink" href="#basic-authentication" title="Permanent link"></a></h4>
<p>You can provide a username and password to the basic authenticator class method. Under the hood, the replicator will
send the credentials in the first request to retrieve a <code>SyncGatewaySession</code> cookie and use it for all subsequent
requests during the replication. This is the recommended way of using basic authentication. <a href="#example-7">Example 7</a>
shows how to initiate a one-shot replication as the user <strong>username</strong> with the password <strong>password</strong>.</p>
<div class="admonition example">
<p class="admonition-title"><span id='example-7'>Example 7. Basic Authentication</span></p>
<div class="language-kotlin highlight"><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="c1">// Create replicator (be sure to hold a reference somewhere that will prevent the Replicator from being GCed)</span>
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a><span class="kd">val</span><span class="w"> </span><span class="nv">repl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Replicator</span><span class="p">(</span>
</span><span id="__span-8-3"><a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a><span class="w">    </span><span class="n">ReplicatorConfigurationFactory</span><span class="p">.</span><span class="na">newConfig</span><span class="p">(</span>
</span><span id="__span-8-4"><a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a><span class="w">        </span><span class="n">database</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">database</span><span class="p">,</span>
</span><span id="__span-8-5"><a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a><span class="w">        </span><span class="n">target</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">URLEndpoint</span><span class="p">(</span><span class="s">&quot;ws://localhost:4984/mydatabase&quot;</span><span class="p">),</span>
</span><span id="__span-8-6"><a id="__codelineno-8-6" name="__codelineno-8-6" href="#__codelineno-8-6"></a><span class="w">        </span><span class="n">authenticator</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BasicAuthenticator</span><span class="p">(</span><span class="s">&quot;username&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;password&quot;</span><span class="p">.</span><span class="na">toCharArray</span><span class="p">())</span>
</span><span id="__span-8-7"><a id="__codelineno-8-7" name="__codelineno-8-7" href="#__codelineno-8-7"></a><span class="w">    </span><span class="p">)</span>
</span><span id="__span-8-8"><a id="__codelineno-8-8" name="__codelineno-8-8" href="#__codelineno-8-8"></a><span class="p">)</span>
</span><span id="__span-8-9"><a id="__codelineno-8-9" name="__codelineno-8-9" href="#__codelineno-8-9"></a><span class="n">repl</span><span class="p">.</span><span class="na">start</span><span class="p">()</span>
</span><span id="__span-8-10"><a id="__codelineno-8-10" name="__codelineno-8-10" href="#__codelineno-8-10"></a><span class="k">this</span><span class="p">.</span><span class="na">replicator</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">repl</span>
</span></code></pre></div>
</div>
<h4 id="session-authentication">Session Authentication<a class="headerlink" href="#session-authentication" title="Permanent link"></a></h4>
<p>Session authentication is another way to authenticate with Sync Gateway.</p>
<p>A user session must first be created through the <a href="https://docs.couchbase.com/sync-gateway/current/rest-api.html#/Session/post_db__session"><code>POST /{db}/_session</code></a> endpoint on the Public REST
API.</p>
<p>The HTTP response contains a session ID which can then be used to authenticate as the user it was created for.</p>
<p>See <a href="#example-8">Example 8</a>, which shows how to initiate a one-shot replication with the session ID returned from the
<a href="https://docs.couchbase.com/sync-gateway/current/rest-api.html#/Session/post_db__session"><code>POST /{db}/_session</code></a>
endpoint.</p>
<div class="admonition example">
<p class="admonition-title"><span id='example-8'>Example 8. Session Authentication</span></p>
<div class="language-kotlin highlight"><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="c1">// Create replicator (be sure to hold a reference somewhere that will prevent the Replicator from being GCed)</span>
</span><span id="__span-9-2"><a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a><span class="kd">val</span><span class="w"> </span><span class="nv">repl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Replicator</span><span class="p">(</span>
</span><span id="__span-9-3"><a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a><span class="w">    </span><span class="n">ReplicatorConfigurationFactory</span><span class="p">.</span><span class="na">newConfig</span><span class="p">(</span>
</span><span id="__span-9-4"><a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a><span class="w">        </span><span class="n">database</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">database</span><span class="p">,</span>
</span><span id="__span-9-5"><a id="__codelineno-9-5" name="__codelineno-9-5" href="#__codelineno-9-5"></a><span class="w">        </span><span class="n">target</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">URLEndpoint</span><span class="p">(</span><span class="s">&quot;ws://localhost:4984/mydatabase&quot;</span><span class="p">),</span>
</span><span id="__span-9-6"><a id="__codelineno-9-6" name="__codelineno-9-6" href="#__codelineno-9-6"></a><span class="w">        </span><span class="n">authenticator</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SessionAuthenticator</span><span class="p">(</span><span class="s">&quot;904ac010862f37c8dd99015a33ab5a3565fd8447&quot;</span><span class="p">)</span>
</span><span id="__span-9-7"><a id="__codelineno-9-7" name="__codelineno-9-7" href="#__codelineno-9-7"></a><span class="w">    </span><span class="p">)</span>
</span><span id="__span-9-8"><a id="__codelineno-9-8" name="__codelineno-9-8" href="#__codelineno-9-8"></a><span class="p">)</span>
</span><span id="__span-9-9"><a id="__codelineno-9-9" name="__codelineno-9-9" href="#__codelineno-9-9"></a><span class="n">repl</span><span class="p">.</span><span class="na">start</span><span class="p">()</span>
</span><span id="__span-9-10"><a id="__codelineno-9-10" name="__codelineno-9-10" href="#__codelineno-9-10"></a><span class="k">this</span><span class="p">.</span><span class="na">replicator</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">repl</span>
</span></code></pre></div>
</div>
<h3 id="custom-headers">Custom Headers<a class="headerlink" href="#custom-headers" title="Permanent link"></a></h3>
<p>Custom headers can be set on the configuration object. The replicator will then include those headers in every request.</p>
<p>This feature is useful in passing additional credentials, perhaps when an authentication or authorization step is being
done by a proxy server (between Couchbase Lite and Sync Gateway) â€” see <a href="#example-9">Example 9</a>.</p>
<div class="admonition example">
<p class="admonition-title"><span id='example-9'>Example 9. Setting custom headers</span></p>
<div class="language-kotlin highlight"><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="c1">// Create replicator (be sure to hold a reference somewhere that will prevent the Replicator from being GCed)</span>
</span><span id="__span-10-2"><a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a><span class="kd">val</span><span class="w"> </span><span class="nv">repl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Replicator</span><span class="p">(</span>
</span><span id="__span-10-3"><a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a><span class="w">    </span><span class="n">ReplicatorConfigurationFactory</span><span class="p">.</span><span class="na">newConfig</span><span class="p">(</span>
</span><span id="__span-10-4"><a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a><span class="w">        </span><span class="n">database</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">database</span><span class="p">,</span>
</span><span id="__span-10-5"><a id="__codelineno-10-5" name="__codelineno-10-5" href="#__codelineno-10-5"></a><span class="w">        </span><span class="n">target</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">URLEndpoint</span><span class="p">(</span><span class="s">&quot;ws://localhost:4984/mydatabase&quot;</span><span class="p">),</span>
</span><span id="__span-10-6"><a id="__codelineno-10-6" name="__codelineno-10-6" href="#__codelineno-10-6"></a><span class="w">        </span><span class="n">headers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mapOf</span><span class="p">(</span><span class="s">&quot;CustomHeaderName&quot;</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="s">&quot;Value&quot;</span><span class="p">)</span>
</span><span id="__span-10-7"><a id="__codelineno-10-7" name="__codelineno-10-7" href="#__codelineno-10-7"></a><span class="w">    </span><span class="p">)</span>
</span><span id="__span-10-8"><a id="__codelineno-10-8" name="__codelineno-10-8" href="#__codelineno-10-8"></a><span class="p">)</span>
</span><span id="__span-10-9"><a id="__codelineno-10-9" name="__codelineno-10-9" href="#__codelineno-10-9"></a><span class="n">repl</span><span class="p">.</span><span class="na">start</span><span class="p">()</span>
</span><span id="__span-10-10"><a id="__codelineno-10-10" name="__codelineno-10-10" href="#__codelineno-10-10"></a><span class="k">this</span><span class="p">.</span><span class="na">replicator</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">repl</span>
</span></code></pre></div>
</div>
<h3 id="replication-filters">Replication Filters<a class="headerlink" href="#replication-filters" title="Permanent link"></a></h3>
<p>Replication Filters allow you to have quick control over the documents stored as the result of a push and/or pull
replication.</p>
<h4 id="push-filter">Push Filter<a class="headerlink" href="#push-filter" title="Permanent link"></a></h4>
<p>The push filter allows an app to push a subset of a database to the server. This can be very useful. For instance,
high-priority documents could be pushed first, or documents in a "draft" state could be skipped.</p>
<div class="language-kotlin highlight"><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a><span class="c1">// Create replicator (be sure to hold a reference somewhere that will prevent the Replicator from being GCed)</span>
</span><span id="__span-11-2"><a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a><span class="kd">val</span><span class="w"> </span><span class="nv">repl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Replicator</span><span class="p">(</span>
</span><span id="__span-11-3"><a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a><span class="w">    </span><span class="n">ReplicatorConfigurationFactory</span><span class="p">.</span><span class="na">newConfig</span><span class="p">(</span>
</span><span id="__span-11-4"><a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a><span class="w">        </span><span class="n">database</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">database</span><span class="p">,</span>
</span><span id="__span-11-5"><a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a><span class="w">        </span><span class="n">target</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">URLEndpoint</span><span class="p">(</span><span class="s">&quot;ws://localhost:4984/mydatabase&quot;</span><span class="p">),</span>
</span><span id="__span-11-6"><a id="__codelineno-11-6" name="__codelineno-11-6" href="#__codelineno-11-6"></a><span class="w">        </span><span class="n">pushFilter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">_</span><span class="p">,</span><span class="w"> </span><span class="n">flags</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">flags</span><span class="p">.</span><span class="na">contains</span><span class="p">(</span><span class="n">DocumentFlag</span><span class="p">.</span><span class="na">DELETED</span><span class="p">)</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-11-7"><a id="__codelineno-11-7" name="__codelineno-11-7" href="#__codelineno-11-7"></a><span class="w">    </span><span class="p">)</span>
</span><span id="__span-11-8"><a id="__codelineno-11-8" name="__codelineno-11-8" href="#__codelineno-11-8"></a><span class="p">)</span>
</span><span id="__span-11-9"><a id="__codelineno-11-9" name="__codelineno-11-9" href="#__codelineno-11-9"></a>
</span><span id="__span-11-10"><a id="__codelineno-11-10" name="__codelineno-11-10" href="#__codelineno-11-10"></a><span class="n">repl</span><span class="p">.</span><span class="na">start</span><span class="p">()</span>
</span><span id="__span-11-11"><a id="__codelineno-11-11" name="__codelineno-11-11" href="#__codelineno-11-11"></a><span class="k">this</span><span class="p">.</span><span class="na">replicator</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">repl</span>
</span></code></pre></div>
<p>The callback should follow the semantics of a <a href="https://en.wikipedia.org/wiki/Pure_function">pure function</a>. Otherwise,
long-running functions would slow down the replicator considerably. Furthermore, your callback should not make
assumptions about what thread it is being called on.</p>
<h4 id="pull-filter">Pull Filter<a class="headerlink" href="#pull-filter" title="Permanent link"></a></h4>
<p>The pull filter gives an app the ability to validate documents being pulled, and skip ones that fail. This is an
important security mechanism in a peer-to-peer topology with peers that are not fully trusted.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Pull replication filters are not a substitute for channels. Sync Gateway <a href="https://docs.couchbase.com/sync-gateway/current/channels.html">channels</a> are designed to be scalable (documents are filtered
on the server) whereas a pull replication filter is applied to a document once it has been downloaded.</p>
</div>
<div class="language-kotlin highlight"><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="c1">// Create replicator (be sure to hold a reference somewhere that will prevent the Replicator from being GCed)</span>
</span><span id="__span-12-2"><a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a><span class="kd">val</span><span class="w"> </span><span class="nv">repl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Replicator</span><span class="p">(</span>
</span><span id="__span-12-3"><a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a><span class="w">    </span><span class="n">ReplicatorConfigurationFactory</span><span class="p">.</span><span class="na">newConfig</span><span class="p">(</span>
</span><span id="__span-12-4"><a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a><span class="w">        </span><span class="n">database</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">database</span><span class="p">,</span>
</span><span id="__span-12-5"><a id="__codelineno-12-5" name="__codelineno-12-5" href="#__codelineno-12-5"></a><span class="w">        </span><span class="n">target</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">URLEndpoint</span><span class="p">(</span><span class="s">&quot;ws://localhost:4984/mydatabase&quot;</span><span class="p">),</span>
</span><span id="__span-12-6"><a id="__codelineno-12-6" name="__codelineno-12-6" href="#__codelineno-12-6"></a><span class="w">        </span><span class="n">pullFilter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">document</span><span class="p">,</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="s">&quot;draft&quot;</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">document</span><span class="p">.</span><span class="na">getString</span><span class="p">(</span><span class="s">&quot;type&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-12-7"><a id="__codelineno-12-7" name="__codelineno-12-7" href="#__codelineno-12-7"></a><span class="w">    </span><span class="p">)</span>
</span><span id="__span-12-8"><a id="__codelineno-12-8" name="__codelineno-12-8" href="#__codelineno-12-8"></a><span class="p">)</span>
</span><span id="__span-12-9"><a id="__codelineno-12-9" name="__codelineno-12-9" href="#__codelineno-12-9"></a>
</span><span id="__span-12-10"><a id="__codelineno-12-10" name="__codelineno-12-10" href="#__codelineno-12-10"></a><span class="n">repl</span><span class="p">.</span><span class="na">start</span><span class="p">()</span>
</span><span id="__span-12-11"><a id="__codelineno-12-11" name="__codelineno-12-11" href="#__codelineno-12-11"></a><span class="k">this</span><span class="p">.</span><span class="na">replicator</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">repl</span>
</span></code></pre></div>
<p>The callback should follow the semantics of a <a href="https://en.wikipedia.org/wiki/Pure_function">pure function</a>. Otherwise,
long-running functions would slow down the replicator considerably. Furthermore, your callback should not make
assumptions about what thread it is being called on.</p>
<div class="admonition warning">
<p class="admonition-title">Losing access to a document via the Sync Function.</p>
<p>Losing access to a document (via the Sync Function) also triggers the pull replication filter.</p>
<p>Filtering out such an event would retain the document locally.</p>
<p>As a result, there would be a local copy of the document disjointed from the one that resides on Couchbase Server.</p>
<p>Further updates to the document stored on Couchbase Server would not be received in pull replications and further local edits could be pushed but the updated versions will not be visible.</p>
<p>For more information, see <a href="#auto-purge-on-channel-access-revocation">Auto-purge on Channel Access Revocation</a>.</p>
</div>
<h3 id="channels">Channels<a class="headerlink" href="#channels" title="Permanent link"></a></h3>
<p>By default, Couchbase Lite gets all the channels to which the configured user account has access.</p>
<p>This behavior is suitable for most apps that rely on <a href="https://docs.couchbase.com/sync-gateway/current/authentication-users.html">user authentication</a> and the <a href="https://docs.couchbase.com/sync-gateway/current/sync-function-api.html">sync function</a> to specify which data to pull for each user.</p>
<p>Optionally, itâ€™s also possible to specify a string array of channel names on Couchbase Liteâ€™s replicator configuration
object. In this case, the replication from Sync Gateway will only pull documents tagged with those channels.</p>
<h3 id="auto-purge-on-channel-access-revocation">Auto-purge on Channel Access Revocation<a class="headerlink" href="#auto-purge-on-channel-access-revocation" title="Permanent link"></a></h3>
<div class="admonition warning">
<p class="admonition-title">This is a Breaking Change at 3.0</p>
</div>
<h4 id="new-outcome">New outcome<a class="headerlink" href="#new-outcome" title="Permanent link"></a></h4>
<p>By default, when a user loses access to a channel all documents in the channel (that do not also belong to any of the
userâ€™s other channels) are auto-purged from the local database (in devices belonging to the user).</p>
<h4 id="prior-outcome">Prior outcome<a class="headerlink" href="#prior-outcome" title="Permanent link"></a></h4>
<p><em>Previously these documents remained in the local database</em></p>
<p>Prior to CBL 3.0, CBL auto-purged only in the case when the user loses access to a document by removing the doc from all
of the channels belonging to the user. Now, in addition to 2.x auto purge, Couchbase Lite also auto-purges the docs when
the user loses access to the doc via channel access revocation. This feature is enabled by default, but an opt-out is
available.</p>
<h4 id="behavior">Behavior<a class="headerlink" href="#behavior" title="Permanent link"></a></h4>
<p>Users may lose access to channels in a number of ways:</p>
<ul>
<li>User loses direct access to channel</li>
<li>User is removed from a role</li>
<li>A channel is removed from a role the user is assigned to</li>
</ul>
<p>By default, when a user loses access to a channel, the next Couchbase Lite pull replication auto-purges all documents in
the channel from local Couchbase Lite databases (on devices belonging to the user) <strong>unless</strong> they belong to any of the
userâ€™s other channels â€” see <a href="#table-2">Table 2</a>.</p>
<p>Documents that exist in multiple channels belonging to the user (even if they are not actively replicating that channel)
are not auto-purged unless the user loses access to all channels.</p>
<p>Users will receive an <code>ACCESS_REMOVED</code> notification from the <code>DocumentReplicationListener</code> if they lose document access
due to channel access revocation; this is sent regardless of the current auto-purge setting.</p>
<p><span id='table-2'><strong>Table 2. Behavior following access revocation</strong></span></p>
<!-- can't have headers span multiple columns in markdown table, so using raw html -->
<table>
<thead>
<tr>
<th style="text-align: center;" colspan="2">System State</th>
<th style="text-align: center;">Impact on Sync</th>
</tr>
</thead>
<tbody>
<tr>
<th style="text-align: center;">Replication Type</th>
<th style="text-align: center;">Access Control on Sync Gateway</th>
<th style="text-align: center;">Expected behavior when <em><code>isAutoPurgeEnabled=true</code></em></th>
</tr>
<tr>
<th style="text-align: center;">Pull only</th>
<td><p>User REVOKED access to channel.</p>
<p>Sync Function includes <code>requireAccess(revokedChannel)</code></p></td>
<td><p>Previously synced documents are auto purged on local</p></td>
</tr>
<tr>
<th style="text-align: center;">Push only</th>
<td><p>User REVOKED access to channel.</p>
<p>Sync Function includes <code>requireAccess(revokedChannel)</code></p></td>
<td><p>No impact of auto-purge</p>
<p>Documents get pushed but are rejected by Sync Gateway</p></td>
</tr>
<tr>
<th style="text-align: center;">Push-pull</th>
<td><p>User REVOKED access to channel.</p>
<p>Sync Function includes <code>requireAccess(revokedChannel)</code></p></td>
<td><p>Previously synced documents are auto purged on Couchbase Lite.</p>
<p>Local changes continue to be  pushed to remote but are rejected by Sync Gateway</p></td>
</tr>
</tbody>
</table>

<p>If a user subsequently regains access to a lost channel, then any previously auto-purged documents still assigned to any
of their channels are automatically pulled down by the active Sync Gateway when they are next updated â€” see behavior
summary in <a href="#table-3">Table 3</a>.</p>
<p><span id='table-3'><strong>Table 3. Behavior if access is regained</strong></span></p>
<!-- can't have headers span multiple columns in markdown table, so using raw html -->
<table>
<thead>
<tr>
<th style="text-align: center;" colspan="2">System State</th>
<th style="text-align: center;">Impact on Sync</th>
</tr>
</thead>
<tbody>
<tr>
<th style="text-align: center;">Replication Type</th>
<th style="text-align: center; min-width:234px">Access Control on Sync Gateway</th>
<th style="text-align: center;">Expected behavior when <em><code>isAutoPurgeEnabled=true</code></em></th>
</tr>
<tr>
<th style="text-align: center;">Pull only</th>
<td>User REASSIGNED access to channel</td>
<td><p>Previously purged documents that are still in the channel are automatically pulled by Couchbase Lite when they are next updated</p></td>
</tr>
<tr>
<th style="text-align: center;">Push only</th>
<td><p>User REASSIGNED access to channel</p>
<p>Sync Function includes <code>requireAccess(reassignedChannel)</code></p>
<p>No impact of auto-purge</p></td>
<td><p>Local changes previously rejected by Sync Gateway will not be automatically pushed to remote unless <code>resetCheckpoint</code> is involved on CBL.</p>
<p>Document changes subsequent to the channel reassignment will be pushed up as usual.</p></td>
</tr>
<tr>
<th style="text-align: center;">Push-pull</th>
<td><p>User REASSIGNED access to channel</p>
<p>Sync Function includes <code>requireAccess(reassignedChannel)</code></p></td>
<td><p>Previously purged documents are automatically pulled by Couchbase Lite</p>
<p>Local changes previously rejected by Sync Gateway will not be automatically pushed to remote unless <code>resetCheckpoint</code> is involved.</p>
<p>Document changes subsequent to the channel reassignment will be pushed up as usual</p></td>
</tr>
</tbody>
</table>

<h4 id="config">Config<a class="headerlink" href="#config" title="Permanent link"></a></h4>
<p>Auto-purge behavior is controlled primarily by the <code>ReplicationConfiguration</code> option <a href="/api/couchbase-lite-ee/kotbase/-replicator-configuration/set-auto-purge-enabled.html"><code>setAutoPurgeEnabled()</code></a>. Changing the state of this will
impact <strong>only</strong> future replications; the replicator will not attempt to sync revisions that were auto purged on channel
access removal. Clients wishing to sync previously removed documents must use the <code>resetCheckpoint</code> API to resync from
the start.</p>
<div class="admonition example">
<p class="admonition-title">Example 10. Setting auto-purge</p>
<div class="language-kotlin highlight"><pre><span></span><code><span id="__span-13-1"><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a><span class="c1">// set auto-purge behavior</span>
</span><span id="__span-13-2"><a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a><span class="c1">// (here we override default)</span>
</span><span id="__span-13-3"><a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a><span class="n">enableAutoPurge</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span>
</span></code></pre></div>
<p>Here we have opted to turn off the auto purge behavior. By default auto purge is enabled.</p>
</div>
<h4 id="overrides">Overrides<a class="headerlink" href="#overrides" title="Permanent link"></a></h4>
<p>Where necessary, clients can override the default auto-purge behavior. This can be done either by setting
<a href="/api/couchbase-lite-ee/kotbase/-replicator-configuration/set-auto-purge-enabled.html"><code>setAutoPurgeEnabled()</code></a> to
<code>false</code>, or for finer control by applying pull-filters â€” see <a href="#table-4">Table 4</a> and <a href="#replication-filters">Replication Filters
</a> This ensures backwards compatible with 2.8 clients that use pull filters to prevent auto purge
of removed docs.</p>
<p><span id='table-4'><strong>Table 4. Impact of Pull-Filters</strong></span></p>
<table>
<tbody>
<tr>
<th style="text-align: center; vertical-align: middle;" rowspan="2">purge_on_removal setting</th>
<th style="text-align: center;" colspan="2">Pull Filter</th>
</tr>
<tr>
<th style="text-align: center;">Not Defined</th>
<th style="text-align: center;">Defined to filter removals/revoked docs</th>
</tr>
<tr>
<td style="text-align: center;">disabled</td>
<td colspan="2"><p>Doc remains in local database</p>
<p>App notified of <code>ACCESS_REMOVED</code> if a <code>DocumentReplicationListener</code> is registered</p></td>
</tr>
<tr>
<td style="text-align: center;">enabled (DEFAULT)</td>
<td><p>Doc is auto purged</p>
<p>App notified of <code>ACCESS_REMOVED</code> if <code>DocumentReplicationListener</code> registered</p></td>
<td>Doc remains in local database</td>
</tr>
</tbody>
</table>

<h3 id="delta-sync">Delta Sync<a class="headerlink" href="#delta-sync" title="Permanent link"></a></h3>
<div class="admonition important">
<p class="admonition-title">This is an <a href="https://www.couchbase.com/products/editions">Enterprise Edition</a> feature.</p>
</div>
<p>With Delta Sync, only the changed parts of a Couchbase document are replicated. This can result in significant savings
in bandwidth consumption as well as throughput improvements, especially when network bandwidth is typically constrained.</p>
<p>Replications to a Server (for example, a Sync Gateway, or passive listener) automatically use delta sync if the property
is enabled at database level by the server â€” see Admin REST API <a href="https://docs.couchbase.com/sync-gateway/current/configuration-schema-database.html#delta_sync-enabled"><code>delta_sync.enabled</code></a> or legacy JSON
configuration <a href="https://docs.couchbase.com/sync-gateway/current/configuration-properties-legacy.html#databases-this_db-delta_sync-enabled"><code>databases.$db.delta_sync.enabled</code></a>.</p>
<p><a href="../intra-device-sync/">Intra-Device</a> replications automatically <strong>disable</strong> delta sync, whilst <a href="../peer-to-peer-sync/">Peer-to-Peer</a> replications automatically <strong>enable</strong> delta sync.</p>
<h2 id="initialize">Initialize<a class="headerlink" href="#initialize" title="Permanent link"></a></h2>
<p><strong>In this section</strong><br />
<a href="#start-replicator">Start Replicator</a> | <a href="#checkpoint-starts">Checkpoint Starts</a></p>
<h3 id="start-replicator">Start Replicator<a class="headerlink" href="#start-replicator" title="Permanent link"></a></h3>
<p>Use the <a href="/api/couchbase-lite-ee/kotbase/-replicator/"><code>Replicator</code></a> classâ€™s <a href="/api/couchbase-lite-ee/kotbase/-replicator/-replicator.html"><code>Replicator(ReplicatorConfiguration)</code></a> constructor, to initialize the replicator with the
configuration you have defined. You can, optionally, add a change listener (see <a href="#monitor">Monitor</a>) before starting the
replicator running using <a href="/api/couchbase-lite-ee/kotbase/-replicator/start.html"><code>start()</code></a>.</p>
<div class="admonition example">
<p class="admonition-title">Example 11. Initialize and run replicator</p>
<div class="language-kotlin highlight"><pre><span></span><code><span id="__span-14-1"><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a><span class="c1">// Create replicator</span>
</span><span id="__span-14-2"><a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a><span class="c1">// Consider holding a reference somewhere</span>
</span><span id="__span-14-3"><a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a><span class="c1">// to prevent the Replicator from being GCed</span>
</span><span id="__span-14-4"><a id="__codelineno-14-4" name="__codelineno-14-4" href="#__codelineno-14-4"></a><span class="kd">val</span><span class="w"> </span><span class="nv">repl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Replicator</span><span class="p">(</span><span class="w"> </span>
</span><span id="__span-14-5"><a id="__codelineno-14-5" name="__codelineno-14-5" href="#__codelineno-14-5"></a>
</span><span id="__span-14-6"><a id="__codelineno-14-6" name="__codelineno-14-6" href="#__codelineno-14-6"></a><span class="w">    </span><span class="c1">// initialize the replicator configuration</span>
</span><span id="__span-14-7"><a id="__codelineno-14-7" name="__codelineno-14-7" href="#__codelineno-14-7"></a><span class="w">    </span><span class="n">ReplicatorConfigurationFactory</span><span class="p">.</span><span class="na">newConfig</span><span class="p">(</span>
</span><span id="__span-14-8"><a id="__codelineno-14-8" name="__codelineno-14-8" href="#__codelineno-14-8"></a><span class="w">        </span><span class="n">database</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">database</span><span class="p">,</span>
</span><span id="__span-14-9"><a id="__codelineno-14-9" name="__codelineno-14-9" href="#__codelineno-14-9"></a>
</span><span id="__span-14-10"><a id="__codelineno-14-10" name="__codelineno-14-10" href="#__codelineno-14-10"></a><span class="w">        </span><span class="n">target</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">URLEndpoint</span><span class="p">(</span><span class="s">&quot;wss://listener.com:8954&quot;</span><span class="p">),</span>
</span><span id="__span-14-11"><a id="__codelineno-14-11" name="__codelineno-14-11" href="#__codelineno-14-11"></a>
</span><span id="__span-14-12"><a id="__codelineno-14-12" name="__codelineno-14-12" href="#__codelineno-14-12"></a><span class="w">        </span><span class="c1">// Set replicator type</span>
</span><span id="__span-14-13"><a id="__codelineno-14-13" name="__codelineno-14-13" href="#__codelineno-14-13"></a><span class="w">        </span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ReplicatorType</span><span class="p">.</span><span class="na">PUSH_AND_PULL</span><span class="p">,</span>
</span><span id="__span-14-14"><a id="__codelineno-14-14" name="__codelineno-14-14" href="#__codelineno-14-14"></a>
</span><span id="__span-14-15"><a id="__codelineno-14-15" name="__codelineno-14-15" href="#__codelineno-14-15"></a><span class="w">        </span><span class="c1">// Configure Sync Mode</span>
</span><span id="__span-14-16"><a id="__codelineno-14-16" name="__codelineno-14-16" href="#__codelineno-14-16"></a><span class="w">        </span><span class="n">continuous</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="c1">// default value</span>
</span><span id="__span-14-17"><a id="__codelineno-14-17" name="__codelineno-14-17" href="#__codelineno-14-17"></a>
</span><span id="__span-14-18"><a id="__codelineno-14-18" name="__codelineno-14-18" href="#__codelineno-14-18"></a><span class="w">        </span><span class="c1">// set auto-purge behavior</span>
</span><span id="__span-14-19"><a id="__codelineno-14-19" name="__codelineno-14-19" href="#__codelineno-14-19"></a><span class="w">        </span><span class="c1">// (here we override default)</span>
</span><span id="__span-14-20"><a id="__codelineno-14-20" name="__codelineno-14-20" href="#__codelineno-14-20"></a><span class="w">        </span><span class="n">enableAutoPurge</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span>
</span><span id="__span-14-21"><a id="__codelineno-14-21" name="__codelineno-14-21" href="#__codelineno-14-21"></a>
</span><span id="__span-14-22"><a id="__codelineno-14-22" name="__codelineno-14-22" href="#__codelineno-14-22"></a><span class="w">        </span><span class="c1">// Configure Server Authentication --</span>
</span><span id="__span-14-23"><a id="__codelineno-14-23" name="__codelineno-14-23" href="#__codelineno-14-23"></a><span class="w">        </span><span class="c1">// only accept self-signed certs</span>
</span><span id="__span-14-24"><a id="__codelineno-14-24" name="__codelineno-14-24" href="#__codelineno-14-24"></a><span class="w">        </span><span class="n">acceptOnlySelfSignedServerCertificate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
</span><span id="__span-14-25"><a id="__codelineno-14-25" name="__codelineno-14-25" href="#__codelineno-14-25"></a>
</span><span id="__span-14-26"><a id="__codelineno-14-26" name="__codelineno-14-26" href="#__codelineno-14-26"></a><span class="w">        </span><span class="c1">// Configure the credentials the</span>
</span><span id="__span-14-27"><a id="__codelineno-14-27" name="__codelineno-14-27" href="#__codelineno-14-27"></a><span class="w">        </span><span class="c1">// client will provide if prompted</span>
</span><span id="__span-14-28"><a id="__codelineno-14-28" name="__codelineno-14-28" href="#__codelineno-14-28"></a><span class="w">        </span><span class="n">authenticator</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BasicAuthenticator</span><span class="p">(</span><span class="s">&quot;PRIVUSER&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;let me in&quot;</span><span class="p">.</span><span class="na">toCharArray</span><span class="p">())</span>
</span><span id="__span-14-29"><a id="__codelineno-14-29" name="__codelineno-14-29" href="#__codelineno-14-29"></a><span class="w">    </span><span class="p">)</span>
</span><span id="__span-14-30"><a id="__codelineno-14-30" name="__codelineno-14-30" href="#__codelineno-14-30"></a><span class="p">)</span>
</span><span id="__span-14-31"><a id="__codelineno-14-31" name="__codelineno-14-31" href="#__codelineno-14-31"></a>
</span><span id="__span-14-32"><a id="__codelineno-14-32" name="__codelineno-14-32" href="#__codelineno-14-32"></a><span class="c1">// Start replicator</span>
</span><span id="__span-14-33"><a id="__codelineno-14-33" name="__codelineno-14-33" href="#__codelineno-14-33"></a><span class="n">repl</span><span class="p">.</span><span class="na">start</span><span class="p">(</span><span class="kc">false</span><span class="p">)</span>
</span><span id="__span-14-34"><a id="__codelineno-14-34" name="__codelineno-14-34" href="#__codelineno-14-34"></a>
</span><span id="__span-14-35"><a id="__codelineno-14-35" name="__codelineno-14-35" href="#__codelineno-14-35"></a><span class="k">this</span><span class="p">.</span><span class="na">replicator</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">repl</span>
</span><span id="__span-14-36"><a id="__codelineno-14-36" name="__codelineno-14-36" href="#__codelineno-14-36"></a><span class="k">this</span><span class="p">.</span><span class="na">token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">token</span>
</span></code></pre></div>
</div>
<ol>
<li>Initialize the replicator with the configuration</li>
<li>Start the replicator</li>
</ol>
<h3 id="checkpoint-starts">Checkpoint Starts<a class="headerlink" href="#checkpoint-starts" title="Permanent link"></a></h3>
<p>Replicators use <a href="https://docs.couchbase.com/couchbase-lite/current/android/refer-glossary.html#checkpoint">checkpoints</a>
to keep track of documents sent to the target database.</p>
<p>Without <a href="https://docs.couchbase.com/couchbase-lite/current/android/refer-glossary.html#checkpoint">checkpoints</a>,
Couchbase Lite would replicate the entire database content to the target database on each connection, even though
previous replications may already have replicated some or all of that content.</p>
<p>This functionality is generally not a concern to application developers. However, if you do want to force the
replication to start again from zero, use the <a href="https://docs.couchbase.com/couchbase-lite/current/android/refer-glossary.html#checkpoint">checkpoint</a> reset argument when starting
the replicator â€” as shown in <a href="#example-12">Example 12</a>.</p>
<div class="admonition example">
<p class="admonition-title"><span id='example12'>Example 12. Resetting checkpoints</span></p>
<div class="language-kotlin highlight"><pre><span></span><code><span id="__span-15-1"><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a><span class="n">repl</span><span class="p">.</span><span class="na">start</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span>
</span></code></pre></div>
</div>
<p>Set startâ€™s reset option to <code>true</code>.<br />
The default <code>false</code> is shown above for completeness only; it is unlikely you would explicitly use it in practice.</p>
<h2 id="monitor">Monitor<a class="headerlink" href="#monitor" title="Permanent link"></a></h2>
<p><strong>In this section</strong><br />
<a href="#change-listeners">Change Listeners</a> | <a href="#replicator-status">Replicator Status</a> | <a href="#monitor-document-changes">Monitor Document Changes
</a> | <a href="#documents-pending-push">Documents Pending Push</a></p>
<p>You can monitor a replicationâ€™s status by using a combination of <a href="#change-listeners">Change Listeners</a> and the
<code>replicator.status.activityLevel</code> property â€” see <a href="/api/couchbase-lite-ee/kotbase/-replicator-status/activity-level.html"><code>activityLevel</code></a>. This enables you to know, for example, when the
replication is actively transferring data and when it has stopped.</p>
<p>You can also choose to monitor document changes â€” see <a href="#monitor-document-changes">Monitor Document Changes</a>.</p>
<h3 id="change-listeners">Change Listeners<a class="headerlink" href="#change-listeners" title="Permanent link"></a></h3>
<p>Use this to monitor changes and to inform on sync progress; this is an optional step. You can add a replicator change
listener at any point; it will report changes from the point it is registered.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Donâ€™t forget to save the token so you can remove the listener later</p>
</div>
<p>Use the <a href="/api/couchbase-lite-ee/kotbase/-replicator/"><code>Replicator</code></a> class to add a change listener as a callback with
<a href="/api/couchbase-lite-ee/kotbase/-replicator/add-change-listener.html"><code>Replicator.addChangeListener()</code></a> â€” see <a href="#example-13">Example
13</a>. You will then be asynchronously notified of state changes.</p>
<p>You can remove a change listener with <a href="/api/couchbase-lite-ee/kotbase/-replicator/remove-change-listener.html"><code>removeChangeListener(ListenerToken)</code></a>.</p>
<h4 id="using-kotlin-flows">Using Kotlin Flows<a class="headerlink" href="#using-kotlin-flows" title="Permanent link"></a></h4>
<p>Kotlin developers can take advantage of <code>Flow</code>s to monitor replicators.</p>
<div class="language-kotlin highlight"><pre><span></span><code><span id="__span-16-1"><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a><span class="kd">fun</span><span class="w"> </span><span class="nf">replChangeFlowExample</span><span class="p">(</span><span class="n">repl</span><span class="p">:</span><span class="w"> </span><span class="n">Replicator</span><span class="p">):</span><span class="w"> </span><span class="n">Flow</span><span class="o">&lt;</span><span class="n">ReplicatorActivityLevel</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-16-2"><a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">repl</span><span class="p">.</span><span class="na">replicatorChangesFlow</span><span class="p">()</span>
</span><span id="__span-16-3"><a id="__codelineno-16-3" name="__codelineno-16-3" href="#__codelineno-16-3"></a><span class="w">        </span><span class="p">.</span><span class="na">map</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nb">it</span><span class="p">.</span><span class="na">status</span><span class="p">.</span><span class="na">activityLevel</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-16-4"><a id="__codelineno-16-4" name="__codelineno-16-4" href="#__codelineno-16-4"></a><span class="p">}</span>
</span></code></pre></div>
<h3 id="replicator-status">Replicator Status<a class="headerlink" href="#replicator-status" title="Permanent link"></a></h3>
<p>You can use the <a href="/api/couchbase-lite-ee/kotbase/-replicator-status/"><code>ReplicatorStatus</code></a> class to check the replicator
status. That is, whether it is actively transferring data or if it has stopped â€” see <a href="#example-13">Example 13</a>.</p>
<p>The returned <code>ReplicatorStatus</code> structure comprises:</p>
<ul>
<li><a href="/api/couchbase-lite-ee/kotbase/-replicator-status/activity-level.html"><code>activityLevel</code></a> â€” <code>STOPPED</code>, <code>OFFLINE</code>,
  <code>CONNECTING</code>, <code>IDLE</code>, or <code>BUSY</code> â€” see states described in <a href="#table-5">Table 5</a></li>
<li><a href="/api/couchbase-lite-ee/kotbase/-replicator-status/progress.html"><code>progress</code></a><ul>
<li><code>completed</code> â€” the total number of changes completed</li>
<li><code>total</code> â€” the total number of changes to be processed</li>
</ul>
</li>
<li><a href="/api/couchbase-lite-ee/kotbase/-replicator-status/error.html"><code>error</code></a> â€” the current error, if any</li>
</ul>
<div class="admonition example">
<p class="admonition-title"><span id='example-13'>Example 13. Monitor replication</span></p>
<div class="tabbed-set tabbed-alternate" data-tabs="2:2"><input checked="checked" id="__tabbed_2_1" name="__tabbed_2" type="radio" /><input id="__tabbed_2_2" name="__tabbed_2" type="radio" /><div class="tabbed-labels"><label for="__tabbed_2_1">Adding a Change Listener</label><label for="__tabbed_2_2">Using replicator.status</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="language-kotlin highlight"><pre><span></span><code><span id="__span-17-1"><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a><span class="kd">val</span><span class="w"> </span><span class="nv">token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">repl</span><span class="p">.</span><span class="na">addChangeListener</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">change</span><span class="w"> </span><span class="o">-&gt;</span>
</span><span id="__span-17-2"><a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a><span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">err</span><span class="p">:</span><span class="w"> </span><span class="n">CouchbaseLiteException? </span><span class="o">=</span><span class="w"> </span><span class="n">change</span><span class="p">.</span><span class="na">status</span><span class="p">.</span><span class="na">error</span>
</span><span id="__span-17-3"><a id="__codelineno-17-3" name="__codelineno-17-3" href="#__codelineno-17-3"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-17-4"><a id="__codelineno-17-4" name="__codelineno-17-4" href="#__codelineno-17-4"></a><span class="w">        </span><span class="n">println</span><span class="p">(</span><span class="s">&quot;Error code :: </span><span class="si">${</span><span class="n">err</span><span class="p">.</span><span class="na">code</span><span class="si">}</span><span class="s">\n</span><span class="si">$</span><span class="n">err</span><span class="s">&quot;</span><span class="p">)</span>
</span><span id="__span-17-5"><a id="__codelineno-17-5" name="__codelineno-17-5" href="#__codelineno-17-5"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-17-6"><a id="__codelineno-17-6" name="__codelineno-17-6" href="#__codelineno-17-6"></a><span class="p">}</span>
</span></code></pre></div>
</div>
<div class="tabbed-block">
<div class="language-kotlin highlight"><pre><span></span><code><span id="__span-18-1"><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a><span class="n">repl</span><span class="p">.</span><span class="na">status</span><span class="p">.</span><span class="na">let</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-18-2"><a id="__codelineno-18-2" name="__codelineno-18-2" href="#__codelineno-18-2"></a><span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">progress</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">it</span><span class="p">.</span><span class="na">progress</span>
</span><span id="__span-18-3"><a id="__codelineno-18-3" name="__codelineno-18-3" href="#__codelineno-18-3"></a><span class="w">    </span><span class="n">println</span><span class="p">(</span>
</span><span id="__span-18-4"><a id="__codelineno-18-4" name="__codelineno-18-4" href="#__codelineno-18-4"></a><span class="w">        </span><span class="s">&quot;The Replicator is </span><span class="si">${</span>
</span><span id="__span-18-5"><a id="__codelineno-18-5" name="__codelineno-18-5" href="#__codelineno-18-5"></a><span class="w">            </span><span class="nb">it</span><span class="p">.</span><span class="na">activityLevel</span>
</span><span id="__span-18-6"><a id="__codelineno-18-6" name="__codelineno-18-6" href="#__codelineno-18-6"></a><span class="w">        </span><span class="si">}</span><span class="s"> and has processed </span><span class="si">${</span>
</span><span id="__span-18-7"><a id="__codelineno-18-7" name="__codelineno-18-7" href="#__codelineno-18-7"></a><span class="w">            </span><span class="n">progress</span><span class="p">.</span><span class="na">completed</span>
</span><span id="__span-18-8"><a id="__codelineno-18-8" name="__codelineno-18-8" href="#__codelineno-18-8"></a><span class="w">        </span><span class="si">}</span><span class="s"> of </span><span class="si">${</span><span class="n">progress</span><span class="p">.</span><span class="na">total</span><span class="si">}</span><span class="s"> changes&quot;</span>
</span><span id="__span-18-9"><a id="__codelineno-18-9" name="__codelineno-18-9" href="#__codelineno-18-9"></a><span class="w">    </span><span class="p">)</span>
</span><span id="__span-18-10"><a id="__codelineno-18-10" name="__codelineno-18-10" href="#__codelineno-18-10"></a><span class="p">}</span>
</span></code></pre></div>
</div>
</div>
</div>
</div>
<h4 id="replication-states">Replication States<a class="headerlink" href="#replication-states" title="Permanent link"></a></h4>
<p><a href="#table-5">Table 5</a> shows the different states, or activity levels, reported in the API; and the meaning of each.</p>
<p><span id='table-5'><strong>Table 5. Replicator activity levels</strong></span></p>
<table>
<thead>
<tr>
<th style="text-align: center;"><div style="min-width:79px">State</div></th>
<th style="text-align: left;">Meaning</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><code>STOPPED</code></td>
<td style="text-align: left;">The replication is finished or hit a fatal error.</td>
</tr>
<tr>
<td style="text-align: center;"><code>OFFLINE</code></td>
<td style="text-align: left;">The replicator is offline as the remote host is unreachable.</td>
</tr>
<tr>
<td style="text-align: center;"><code>CONNECTING</code></td>
<td style="text-align: left;">The replicator is connecting to the remote host.</td>
</tr>
<tr>
<td style="text-align: center;"><code>IDLE</code></td>
<td style="text-align: left;">The replication caught up with all the changes available from the server. The <code>IDLE</code> state is only used in continuous replications.</td>
</tr>
<tr>
<td style="text-align: center;"><code>BUSY</code></td>
<td style="text-align: left;">The replication is actively transferring data.</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The replication change object also has properties to track the progress (<code>change.status.completed</code> and
<code>change.status.total</code>). Since the replication occurs in batches the total count can vary through the course of a
replication.</p>
</div>
<h4 id="replication-status-and-app-life-cycle">Replication Status and App Life Cycle<a class="headerlink" href="#replication-status-and-app-life-cycle" title="Permanent link"></a></h4>
<h5 id="ios">iOS<a class="headerlink" href="#ios" title="Permanent link"></a></h5>
<p>The following diagram describes the status changes when the application starts a replication, and when the application
is being backgrounded or foregrounded by the OS. It applies to iOS only.</p>
<p><img alt="iOS Replicator States" loading="lazy" src="../assets/images/ios-replicator-states.png" /></p>
<p>Additionally, on iOS, an app already in the background may be terminated. In this case, the <code>Database</code> and <code>Replicator</code>
instances will be <code>null</code> when the app returns to the foreground. Therefore, as preventive measure, it is recommended to
do a <code>null</code> check when the app enters the foreground, and to re-initialize the database and replicator if any of those
are <code>null</code>.</p>
<p>On other platforms, Couchbase Lite doesnâ€™t react to OS backgrounding or foregrounding events and replication(s) will
continue running as long as the remote system does not terminate the connection and the app does not terminate. It is
generally recommended to stop replications before going into the background otherwise socket connections may be closed
by the OS and this may interfere with the replication process.</p>
<h5 id="other-platforms">Other Platforms<a class="headerlink" href="#other-platforms" title="Permanent link"></a></h5>
<p>Couchbase Lite replications will continue running until the app terminates, unless the remote system, or the
application, terminates the connection.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Recall that the Android OS may kill an application without warning. You should explicitly stop replication processes
when they are no longer useful (for example, when the app is in the background and the replication is <code>IDLE</code>) to
avoid socket connections being closed by the OS, which may interfere with the replication process.</p>
</div>
<h3 id="monitor-document-changes">Monitor Document Changes<a class="headerlink" href="#monitor-document-changes" title="Permanent link"></a></h3>
<p>You can choose to register for document updates during a replication.</p>
<p>For example, the code snippet in <a href="#example-14">Example 14</a> registers a listener to monitor document replication
performed by the replicator referenced by the variable <code>repl</code>. It prints the document ID of each document received and
sent. Stop the listener as shown in <a href="#example-15">Example 15</a>.</p>
<div class="admonition example">
<p class="admonition-title"><span id='example-14'>Example 14. Register a document listener</span></p>
<div class="language-kotlin highlight"><pre><span></span><code><span id="__span-19-1"><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a><span class="kd">val</span><span class="w"> </span><span class="nv">token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">repl</span><span class="p">.</span><span class="na">addDocumentReplicationListener</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">replication</span><span class="w"> </span><span class="o">-&gt;</span>
</span><span id="__span-19-2"><a id="__codelineno-19-2" name="__codelineno-19-2" href="#__codelineno-19-2"></a><span class="w">    </span><span class="n">println</span><span class="p">(</span><span class="s">&quot;Replication type: </span><span class="si">${</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">replication</span><span class="p">.</span><span class="na">isPush</span><span class="p">)</span><span class="w"> </span><span class="s">&quot;</span><span class="n">push</span><span class="s">&quot;</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s">&quot;</span><span class="n">pull</span><span class="s">&quot;</span><span class="si">}</span><span class="s">&quot;</span><span class="p">)</span>
</span><span id="__span-19-3"><a id="__codelineno-19-3" name="__codelineno-19-3" href="#__codelineno-19-3"></a>
</span><span id="__span-19-4"><a id="__codelineno-19-4" name="__codelineno-19-4" href="#__codelineno-19-4"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">doc</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">replication</span><span class="p">.</span><span class="na">documents</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-19-5"><a id="__codelineno-19-5" name="__codelineno-19-5" href="#__codelineno-19-5"></a><span class="w">        </span><span class="n">println</span><span class="p">(</span><span class="s">&quot;Doc ID: </span><span class="si">${</span><span class="n">doc</span><span class="p">.</span><span class="na">id</span><span class="si">}</span><span class="s">&quot;</span><span class="p">)</span>
</span><span id="__span-19-6"><a id="__codelineno-19-6" name="__codelineno-19-6" href="#__codelineno-19-6"></a>
</span><span id="__span-19-7"><a id="__codelineno-19-7" name="__codelineno-19-7" href="#__codelineno-19-7"></a><span class="w">        </span><span class="n">doc</span><span class="p">.</span><span class="na">error</span><span class="o">?.</span><span class="na">let</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-19-8"><a id="__codelineno-19-8" name="__codelineno-19-8" href="#__codelineno-19-8"></a><span class="w">            </span><span class="c1">// There was an error</span>
</span><span id="__span-19-9"><a id="__codelineno-19-9" name="__codelineno-19-9" href="#__codelineno-19-9"></a><span class="w">            </span><span class="n">println</span><span class="p">(</span><span class="s">&quot;Error replicating document: </span><span class="si">$</span><span class="n">it</span><span class="s">&quot;</span><span class="p">)</span>
</span><span id="__span-19-10"><a id="__codelineno-19-10" name="__codelineno-19-10" href="#__codelineno-19-10"></a><span class="w">            </span><span class="k">return</span><span class="nd">@addDocumentReplicationListener</span>
</span><span id="__span-19-11"><a id="__codelineno-19-11" name="__codelineno-19-11" href="#__codelineno-19-11"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-19-12"><a id="__codelineno-19-12" name="__codelineno-19-12" href="#__codelineno-19-12"></a>
</span><span id="__span-19-13"><a id="__codelineno-19-13" name="__codelineno-19-13" href="#__codelineno-19-13"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">doc</span><span class="p">.</span><span class="na">flags</span><span class="p">.</span><span class="na">contains</span><span class="p">(</span><span class="n">DocumentFlag</span><span class="p">.</span><span class="na">DELETED</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-19-14"><a id="__codelineno-19-14" name="__codelineno-19-14" href="#__codelineno-19-14"></a><span class="w">            </span><span class="n">println</span><span class="p">(</span><span class="s">&quot;Successfully replicated a deleted document&quot;</span><span class="p">)</span>
</span><span id="__span-19-15"><a id="__codelineno-19-15" name="__codelineno-19-15" href="#__codelineno-19-15"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-19-16"><a id="__codelineno-19-16" name="__codelineno-19-16" href="#__codelineno-19-16"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-19-17"><a id="__codelineno-19-17" name="__codelineno-19-17" href="#__codelineno-19-17"></a><span class="p">}</span>
</span><span id="__span-19-18"><a id="__codelineno-19-18" name="__codelineno-19-18" href="#__codelineno-19-18"></a>
</span><span id="__span-19-19"><a id="__codelineno-19-19" name="__codelineno-19-19" href="#__codelineno-19-19"></a><span class="n">repl</span><span class="p">.</span><span class="na">start</span><span class="p">()</span>
</span><span id="__span-19-20"><a id="__codelineno-19-20" name="__codelineno-19-20" href="#__codelineno-19-20"></a><span class="k">this</span><span class="p">.</span><span class="na">replicator</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">repl</span>
</span></code></pre></div>
</div>
<div class="admonition example">
<p class="admonition-title"><span id='example-15'>Example 15. Stop document listener</span></p>
<p>This code snippet shows how to stop the document listener using the token from the previous example.</p>
<div class="language-kotlin highlight"><pre><span></span><code><span id="__span-20-1"><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a><span class="n">repl</span><span class="p">.</span><span class="na">removeChangeListener</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
</span></code></pre></div>
</div>
<h4 id="document-access-removal-behavior">Document Access Removal Behavior<a class="headerlink" href="#document-access-removal-behavior" title="Permanent link"></a></h4>
<p>When access to a document is removed on Sync Gateway (see Sync Gatewayâ€™s <a href="https://docs.couchbase.com/sync-gateway/current/sync-function-api.html">Sync Function</a>), the document replication listener sends a
notification with the <code>ACCESS_REMOVED</code> flag set to <code>true</code> and subsequently purges the document from the database.</p>
<h3 id="documents-pending-push">Documents Pending Push<a class="headerlink" href="#documents-pending-push" title="Permanent link"></a></h3>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p><a href="/api/couchbase-lite-ee/kotbase/-replicator/is-document-pending.html"><code>Replicator.isDocumentPending()</code></a> is quicker
and more efficient. Use it in preference to returning a list of pending document IDs, where possible.</p>
</div>
<p>You can check whether documents are waiting to be pushed in any forthcoming sync by using either of the following API
methods:</p>
<ul>
<li>Use the <a href="/api/couchbase-lite-ee/kotbase/-replicator/get-pending-document-ids.html"><code>Replicator.getPendingDocumentIds()</code></a> method, which returns a list of document IDs
  that have local changes, but which have not yet been pushed to the server.<br><br>
  This can be very useful in tracking the progress of a push sync, enabling the app to provide a visual indicator to the
  end user on its status, or decide when it is safe to exit.</li>
<li>Use the <a href="/api/couchbase-lite-ee/kotbase/-replicator/is-document-pending.html"><code>Replicator.isDocumentPending()</code></a> method
  to quickly check whether an individual document is pending a push.</li>
</ul>
<div class="admonition example">
<p class="admonition-title">Example 16. Use Pending Document ID API</p>
<div class="language-kotlin highlight"><pre><span></span><code><span id="__span-21-1"><a id="__codelineno-21-1" name="__codelineno-21-1" href="#__codelineno-21-1"></a><span class="kd">val</span><span class="w"> </span><span class="nv">repl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Replicator</span><span class="p">(</span>
</span><span id="__span-21-2"><a id="__codelineno-21-2" name="__codelineno-21-2" href="#__codelineno-21-2"></a><span class="w">    </span><span class="n">ReplicatorConfigurationFactory</span><span class="p">.</span><span class="na">newConfig</span><span class="p">(</span>
</span><span id="__span-21-3"><a id="__codelineno-21-3" name="__codelineno-21-3" href="#__codelineno-21-3"></a><span class="w">        </span><span class="n">database</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">database</span><span class="p">,</span>
</span><span id="__span-21-4"><a id="__codelineno-21-4" name="__codelineno-21-4" href="#__codelineno-21-4"></a><span class="w">        </span><span class="n">target</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">URLEndpoint</span><span class="p">(</span><span class="s">&quot;ws://localhost:4984/mydatabase&quot;</span><span class="p">),</span>
</span><span id="__span-21-5"><a id="__codelineno-21-5" name="__codelineno-21-5" href="#__codelineno-21-5"></a><span class="w">        </span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ReplicatorType</span><span class="p">.</span><span class="na">PUSH</span>
</span><span id="__span-21-6"><a id="__codelineno-21-6" name="__codelineno-21-6" href="#__codelineno-21-6"></a><span class="w">    </span><span class="p">)</span>
</span><span id="__span-21-7"><a id="__codelineno-21-7" name="__codelineno-21-7" href="#__codelineno-21-7"></a><span class="p">)</span>
</span><span id="__span-21-8"><a id="__codelineno-21-8" name="__codelineno-21-8" href="#__codelineno-21-8"></a>
</span><span id="__span-21-9"><a id="__codelineno-21-9" name="__codelineno-21-9" href="#__codelineno-21-9"></a><span class="kd">val</span><span class="w"> </span><span class="nv">pendingDocs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">repl</span><span class="p">.</span><span class="na">getPendingDocumentIds</span><span class="p">()</span>
</span><span id="__span-21-10"><a id="__codelineno-21-10" name="__codelineno-21-10" href="#__codelineno-21-10"></a>
</span><span id="__span-21-11"><a id="__codelineno-21-11" name="__codelineno-21-11" href="#__codelineno-21-11"></a><span class="c1">// iterate and report on previously</span>
</span><span id="__span-21-12"><a id="__codelineno-21-12" name="__codelineno-21-12" href="#__codelineno-21-12"></a><span class="c1">// retrieved pending docIds &#39;list&#39;</span>
</span><span id="__span-21-13"><a id="__codelineno-21-13" name="__codelineno-21-13" href="#__codelineno-21-13"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pendingDocs</span><span class="p">.</span><span class="na">isNotEmpty</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-21-14"><a id="__codelineno-21-14" name="__codelineno-21-14" href="#__codelineno-21-14"></a><span class="w">    </span><span class="n">println</span><span class="p">(</span><span class="s">&quot;There are </span><span class="si">${</span><span class="n">pendingDocs</span><span class="p">.</span><span class="na">size</span><span class="si">}</span><span class="s"> documents pending&quot;</span><span class="p">)</span>
</span><span id="__span-21-15"><a id="__codelineno-21-15" name="__codelineno-21-15" href="#__codelineno-21-15"></a>
</span><span id="__span-21-16"><a id="__codelineno-21-16" name="__codelineno-21-16" href="#__codelineno-21-16"></a><span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">firstDoc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pendingDocs</span><span class="p">.</span><span class="na">first</span><span class="p">()</span>
</span><span id="__span-21-17"><a id="__codelineno-21-17" name="__codelineno-21-17" href="#__codelineno-21-17"></a><span class="w">    </span><span class="n">repl</span><span class="p">.</span><span class="na">addChangeListener</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">change</span><span class="w"> </span><span class="o">-&gt;</span>
</span><span id="__span-21-18"><a id="__codelineno-21-18" name="__codelineno-21-18" href="#__codelineno-21-18"></a><span class="w">        </span><span class="n">println</span><span class="p">(</span><span class="s">&quot;Replicator activity level is </span><span class="si">${</span><span class="n">change</span><span class="p">.</span><span class="na">status</span><span class="p">.</span><span class="na">activityLevel</span><span class="si">}</span><span class="s">&quot;</span><span class="p">)</span>
</span><span id="__span-21-19"><a id="__codelineno-21-19" name="__codelineno-21-19" href="#__codelineno-21-19"></a><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-21-20"><a id="__codelineno-21-20" name="__codelineno-21-20" href="#__codelineno-21-20"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">repl</span><span class="p">.</span><span class="na">isDocumentPending</span><span class="p">(</span><span class="n">firstDoc</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-21-21"><a id="__codelineno-21-21" name="__codelineno-21-21" href="#__codelineno-21-21"></a><span class="w">                </span><span class="n">println</span><span class="p">(</span><span class="s">&quot;Doc ID </span><span class="si">$</span><span class="n">firstDoc</span><span class="s"> has been pushed&quot;</span><span class="p">)</span>
</span><span id="__span-21-22"><a id="__codelineno-21-22" name="__codelineno-21-22" href="#__codelineno-21-22"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-21-23"><a id="__codelineno-21-23" name="__codelineno-21-23" href="#__codelineno-21-23"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">err</span><span class="p">:</span><span class="w"> </span><span class="n">CouchbaseLiteException</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-21-24"><a id="__codelineno-21-24" name="__codelineno-21-24" href="#__codelineno-21-24"></a><span class="w">            </span><span class="n">println</span><span class="p">(</span><span class="s">&quot;Failed getting pending docs\n</span><span class="si">$</span><span class="n">err</span><span class="s">&quot;</span><span class="p">)</span>
</span><span id="__span-21-25"><a id="__codelineno-21-25" name="__codelineno-21-25" href="#__codelineno-21-25"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-21-26"><a id="__codelineno-21-26" name="__codelineno-21-26" href="#__codelineno-21-26"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-21-27"><a id="__codelineno-21-27" name="__codelineno-21-27" href="#__codelineno-21-27"></a>
</span><span id="__span-21-28"><a id="__codelineno-21-28" name="__codelineno-21-28" href="#__codelineno-21-28"></a><span class="w">    </span><span class="n">repl</span><span class="p">.</span><span class="na">start</span><span class="p">()</span>
</span><span id="__span-21-29"><a id="__codelineno-21-29" name="__codelineno-21-29" href="#__codelineno-21-29"></a><span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="na">replicator</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">repl</span>
</span><span id="__span-21-30"><a id="__codelineno-21-30" name="__codelineno-21-30" href="#__codelineno-21-30"></a><span class="p">}</span>
</span></code></pre></div>
</div>
<ol>
<li><a href="/api/couchbase-lite-ee/kotbase/-replicator/get-pending-document-ids.html"><code>Replicator.getPendingDocumentIds()</code></a>
   returns a list of the document IDs for all documents waiting to be pushed. This is a snapshot and may have changed by
   the time the response is received and processed.</li>
<li><a href="/api/couchbase-lite-ee/kotbase/-replicator/is-document-pending.html"><code>Replicator.isDocumentPending()</code></a> returns
   <code>true</code> if the document is waiting to be pushed, and <code>false</code> otherwise.</li>
</ol>
<h2 id="stop">Stop<a class="headerlink" href="#stop" title="Permanent link"></a></h2>
<p>Stopping a replication is straightforward. It is done using <a href="/api/couchbase-lite-ee/kotbase/-replicator/stop.html"><code>stop()</code></a>. This initiates an asynchronous operation and so is not
necessarily immediate. Your app should account for this potential delay before attempting any subsequent operations.</p>
<p>You can find further information on database operations in <a href="../databases/">Databases</a>.</p>
<div class="admonition example">
<p class="admonition-title">Example 17. Stop replicator</p>
<div class="language-kotlin highlight"><pre><span></span><code><span id="__span-22-1"><a id="__codelineno-22-1" name="__codelineno-22-1" href="#__codelineno-22-1"></a><span class="c1">// Stop replication.</span>
</span><span id="__span-22-2"><a id="__codelineno-22-2" name="__codelineno-22-2" href="#__codelineno-22-2"></a><span class="n">repl</span><span class="p">.</span><span class="na">stop</span><span class="p">()</span>
</span></code></pre></div>
</div>
<p>Here we initiate the stopping of the replication using the <a href="/api/couchbase-lite-ee/kotbase/-replicator/stop.html"><code>stop()</code></a> method. It will stop any active <a href="#change-listeners">change listener
</a> once the replication is stopped.</p>
<h2 id="error-handling">Error Handling<a class="headerlink" href="#error-handling" title="Permanent link"></a></h2>
<p>When a <em>replicator</em> detects a network error it updates its status depending on the error type (permanent or temporary)
and returns an appropriate HTTP error code.</p>
<p>The following code snippet adds a <a href="#change-listeners">change listener</a>, which monitors a replication for errors and logs
the returned error code.</p>
<div class="admonition example">
<p class="admonition-title">Example 18. Monitoring for network errors</p>
<div class="language-kotlin highlight"><pre><span></span><code><span id="__span-23-1"><a id="__codelineno-23-1" name="__codelineno-23-1" href="#__codelineno-23-1"></a><span class="n">repl</span><span class="p">.</span><span class="na">addChangeListener</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">change</span><span class="w"> </span><span class="o">-&gt;</span>
</span><span id="__span-23-2"><a id="__codelineno-23-2" name="__codelineno-23-2" href="#__codelineno-23-2"></a><span class="w">    </span><span class="n">change</span><span class="p">.</span><span class="na">status</span><span class="p">.</span><span class="na">error</span><span class="o">?.</span><span class="na">let</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-23-3"><a id="__codelineno-23-3" name="__codelineno-23-3" href="#__codelineno-23-3"></a><span class="w">        </span><span class="n">println</span><span class="p">(</span><span class="s">&quot;Error code: </span><span class="si">${</span><span class="nb">it</span><span class="p">.</span><span class="na">code</span><span class="si">}</span><span class="s">&quot;</span><span class="p">)</span>
</span><span id="__span-23-4"><a id="__codelineno-23-4" name="__codelineno-23-4" href="#__codelineno-23-4"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-23-5"><a id="__codelineno-23-5" name="__codelineno-23-5" href="#__codelineno-23-5"></a><span class="p">}</span>
</span><span id="__span-23-6"><a id="__codelineno-23-6" name="__codelineno-23-6" href="#__codelineno-23-6"></a><span class="n">repl</span><span class="p">.</span><span class="na">start</span><span class="p">()</span>
</span><span id="__span-23-7"><a id="__codelineno-23-7" name="__codelineno-23-7" href="#__codelineno-23-7"></a><span class="k">this</span><span class="p">.</span><span class="na">replicator</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">repl</span>
</span></code></pre></div>
</div>
<p><strong>For permanent network errors</strong> (for example, <code>404</code> not found, or <code>401</code> unauthorized): <em>Replicator</em> will stop
permanently, whether <code>setContinuous</code> is <em>true</em> or <em>false</em>. Of course, it sets its status to <code>STOPPED</code>.</p>
<p><strong>For recoverable or temporary errors</strong>: <em>Replicator</em> sets its status to <code>OFFLINE</code>, then:</p>
<ul>
<li>If <code>setContinuous=<em>true</em></code> it retries the connection indefinitely</li>
<li>If <code>setContinuous=<em>false</em></code> (one-shot) it retries the connection a limited number of times.</li>
</ul>
<p>The following error codes are considered temporary by the Couchbase Lite replicator and thus will trigger a connection
retry:</p>
<ul>
<li><code>408</code>: Request Timeout</li>
<li><code>429</code>: Too Many Requests</li>
<li><code>500</code>: Internal Server Error</li>
<li><code>502</code>: Bad Gateway</li>
<li><code>503</code>: Service Unavailable</li>
<li><code>504</code>: Gateway Timeout</li>
<li><code>1001</code>: DNS resolution error</li>
</ul>
<h3 id="using-kotlin-flows_1">Using Kotlin Flows<a class="headerlink" href="#using-kotlin-flows_1" title="Permanent link"></a></h3>
<p>Kotlin developers can also take advantage of <code>Flow</code>s to monitor replicators.</p>
<div class="language-kotlin highlight"><pre><span></span><code><span id="__span-24-1"><a id="__codelineno-24-1" name="__codelineno-24-1" href="#__codelineno-24-1"></a><span class="n">scope</span><span class="p">.</span><span class="na">launch</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-24-2"><a id="__codelineno-24-2" name="__codelineno-24-2" href="#__codelineno-24-2"></a><span class="w">    </span><span class="n">repl</span><span class="p">.</span><span class="na">replicatorChangesFlow</span><span class="p">()</span>
</span><span id="__span-24-3"><a id="__codelineno-24-3" name="__codelineno-24-3" href="#__codelineno-24-3"></a><span class="w">        </span><span class="p">.</span><span class="na">mapNotNull</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nb">it</span><span class="p">.</span><span class="na">status</span><span class="p">.</span><span class="na">error</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-24-4"><a id="__codelineno-24-4" name="__codelineno-24-4" href="#__codelineno-24-4"></a><span class="w">        </span><span class="p">.</span><span class="na">collect</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="o">-&gt;</span>
</span><span id="__span-24-5"><a id="__codelineno-24-5" name="__codelineno-24-5" href="#__codelineno-24-5"></a><span class="w">            </span><span class="n">println</span><span class="p">(</span><span class="s">&quot;Replication error :: </span><span class="si">$</span><span class="n">error</span><span class="s">&quot;</span><span class="p">)</span>
</span><span id="__span-24-6"><a id="__codelineno-24-6" name="__codelineno-24-6" href="#__codelineno-24-6"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-24-7"><a id="__codelineno-24-7" name="__codelineno-24-7" href="#__codelineno-24-7"></a><span class="p">}</span>
</span></code></pre></div>
<h2 id="load-balancers">Load Balancers<a class="headerlink" href="#load-balancers" title="Permanent link"></a></h2>
<p>Couchbase Lite uses WebSockets as the communication protocol to transmit data. Some load balancers are not configured
for WebSocket connections by default (NGINX for example); so it might be necessary to explicitly enable them in the load
balancerâ€™s configuration â€” see <a href="https://docs.couchbase.com/sync-gateway/current/load-balancer.html">Load Balancers</a>.</p>
<p>By default, the WebSocket protocol uses compression to optimize for speed and bandwidth utilization. The level of
compression is set on Sync Gateway and can be tuned in the configuration file (<a href="https://docs.couchbase.com/sync-gateway/current/configuration-properties-legacy.html#replicator_compression"><code>replicator_compression</code></a>).</p>
<h2 id="certificate-pinning">Certificate Pinning<a class="headerlink" href="#certificate-pinning" title="Permanent link"></a></h2>
<p>Couchbase Lite supports certificate pinning.</p>
<p>Certificate pinning is a technique that can be used by applications to "pin" a host to its certificate. The certificate
is typically delivered to the client by an out-of-band channel and bundled with the client. In this case, Couchbase Lite
uses this embedded certificate to verify the trustworthiness of the server (for example, a Sync Gateway) and no longer
needs to rely on a trusted third party for that (commonly referred to as the Certificate Authority).</p>
<p>For the 3.0.2. release, changes have been made to the way certificates on the host are matched:</p>
<!-- can't have no headers in markdown table, so using raw html -->
<table><tbody>
<tr>
<th>Prior to CBL 3.0.2</th>
<td>The pinned certificate was only compared with the leaf certificate of the host. This is not always suitable as leaf
certificates are usually valid for shorter periods of time.</td>
</tr>
<tr>
<th>CBL 3.0.2+</th>
<td>The pinned certificate will be compared against any certificate in the serverâ€™s certificate chain.</td>
</tr>
</tbody></table>

<p>The following steps describe how to configure certificate pinning between Couchbase Lite and Sync Gateway:</p>
<ol>
<li><a href="https://docs.couchbase.com/sync-gateway/current/authentication-certs.html#creating-a-self-signed-certificate">Create your own self-signed certificate</a> with
   the <code>openssl</code> command. After completing this step, you should have 3 files: <code>cert.pem</code>, <code>cert.cer</code>, and
   <code>privkey.pem</code>.</li>
<li><a href="https://docs.couchbase.com/sync-gateway/current/authentication-certs.html#installing-the-certificate">Configure Sync Gateway</a> with the
   <code>cert.pem</code> and <code>privkey.pem</code> files. After completing this step, Sync Gateway is reachable over <code>https</code>/<code>wss</code>.</li>
<li>On the Couchbase Lite side, the replication must point to a URL with the <code>wss</code> scheme and configured with the
   <code>cert.cer</code> file created in step 1.</li>
</ol>
<p>This example loads the certificate from the application sandbox, then converts it to the appropriate type to configure the replication object.</p>
<div class="admonition example">
<p class="admonition-title">Example 19. Cert Pinnings</p>
<div class="language-kotlin highlight"><pre><span></span><code><span id="__span-25-1"><a id="__codelineno-25-1" name="__codelineno-25-1" href="#__codelineno-25-1"></a><span class="kd">val</span><span class="w"> </span><span class="nv">repl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Replicator</span><span class="p">(</span>
</span><span id="__span-25-2"><a id="__codelineno-25-2" name="__codelineno-25-2" href="#__codelineno-25-2"></a><span class="w">    </span><span class="n">ReplicatorConfigurationFactory</span><span class="p">.</span><span class="na">newConfig</span><span class="p">(</span>
</span><span id="__span-25-3"><a id="__codelineno-25-3" name="__codelineno-25-3" href="#__codelineno-25-3"></a><span class="w">        </span><span class="n">database</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">database</span><span class="p">,</span>
</span><span id="__span-25-4"><a id="__codelineno-25-4" name="__codelineno-25-4" href="#__codelineno-25-4"></a><span class="w">        </span><span class="n">target</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">URLEndpoint</span><span class="p">(</span><span class="s">&quot;wss://localhost:4984/mydatabase&quot;</span><span class="p">),</span>
</span><span id="__span-25-5"><a id="__codelineno-25-5" name="__codelineno-25-5" href="#__codelineno-25-5"></a><span class="w">        </span><span class="n">pinnedServerCertificate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PlatformUtils</span><span class="p">.</span><span class="na">getAsset</span><span class="p">(</span><span class="s">&quot;cert.cer&quot;</span><span class="p">)</span><span class="o">?.</span><span class="na">readByteArray</span><span class="p">()</span>
</span><span id="__span-25-6"><a id="__codelineno-25-6" name="__codelineno-25-6" href="#__codelineno-25-6"></a><span class="w">    </span><span class="p">)</span>
</span><span id="__span-25-7"><a id="__codelineno-25-7" name="__codelineno-25-7" href="#__codelineno-25-7"></a><span class="p">)</span>
</span><span id="__span-25-8"><a id="__codelineno-25-8" name="__codelineno-25-8" href="#__codelineno-25-8"></a><span class="n">repl</span><span class="p">.</span><span class="na">start</span><span class="p">()</span>
</span><span id="__span-25-9"><a id="__codelineno-25-9" name="__codelineno-25-9" href="#__codelineno-25-9"></a><span class="k">this</span><span class="p">.</span><span class="na">replicator</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">repl</span>
</span></code></pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><code>PlatformUtils.getAsset()</code> needs to be implemented in a platform-specific way â€” see <a href="https://github.com/jeffdgr8/kotbase/blob/main/testing-support/src/commonMain/kotlin/kotbase/internal/utils/PlatformUtils.kt">example in Kotbase tests</a>.</p>
</div>
<p>The replication should now run successfully over <code>https</code>/<code>wss</code> with certificate pinning.</p>
<p>For more on pinning certificates see the blog entry: <a href="https://blog.couchbase.com/certificate-pinning-android-with-couchbase-mobile/">Certificate Pinning with Couchbase Mobile</a>.</p>
<h2 id="troubleshooting">Troubleshooting<a class="headerlink" href="#troubleshooting" title="Permanent link"></a></h2>
<h3 id="logs">Logs<a class="headerlink" href="#logs" title="Permanent link"></a></h3>
<p>As always, when there is a problem with replication, logging is your friend. You can increase the log output for
activity related to replication with Sync Gateway â€” see <a href="#example-20">Example 20</a>.</p>
<div class="admonition example">
<p class="admonition-title">Example 20. Set logging verbosity</p>
<div class="language-kotlin highlight"><pre><span></span><code><span id="__span-26-1"><a id="__codelineno-26-1" name="__codelineno-26-1" href="#__codelineno-26-1"></a><span class="n">Database</span><span class="p">.</span><span class="na">log</span><span class="p">.</span><span class="na">console</span><span class="p">.</span><span class="na">setDomains</span><span class="p">(</span><span class="n">LogDomain</span><span class="p">.</span><span class="na">REPLICATOR</span><span class="p">)</span>
</span><span id="__span-26-2"><a id="__codelineno-26-2" name="__codelineno-26-2" href="#__codelineno-26-2"></a><span class="n">Database</span><span class="p">.</span><span class="na">log</span><span class="p">.</span><span class="na">console</span><span class="p">.</span><span class="na">level</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LogLevel</span><span class="p">.</span><span class="na">DEBUG</span>
</span></code></pre></div>
</div>
<p>For more on troubleshooting with logs, see <a href="../using-logs/">Using Logs</a>.</p>
<h3 id="authentication-errors">Authentication Errors<a class="headerlink" href="#authentication-errors" title="Permanent link"></a></h3>
<p>If Sync Gateway is configured with a self-signed certificate but your app points to a <code>ws</code> scheme instead of <code>wss</code> you
will encounter an error with status code <code>11006</code> â€” see <a href="#example-21">Example 21</a>.</p>
<div class="admonition example">
<p class="admonition-title"><span id='example-21'>Example 21. Protocol Mismatch</span></p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-27-1"><a id="__codelineno-27-1" name="__codelineno-27-1" href="#__codelineno-27-1"></a>CouchbaseLite Replicator ERROR: {Repl#2} Got LiteCore error: WebSocket error 1006 &quot;connection closed abnormally&quot;
</span></code></pre></div>
</div>
<p>If Sync Gateway is configured with a self-signed certificate, and your app points to a <code>wss</code> scheme but the replicator
configuration isnâ€™t using the certificate you will encounter an error with status code <code>5011</code> â€” see <a href="#example-22">Example 22
</a>.</p>
<div class="admonition example">
<p class="admonition-title"><span id='example-22'>Example 22. Certificate Mismatch or Not Found</span></p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-28-1"><a id="__codelineno-28-1" name="__codelineno-28-1" href="#__codelineno-28-1"></a>CouchbaseLite Replicator ERROR: {Repl#2} Got LiteCore error: Network error 11 &quot;server TLS certificate is self-signed or has unknown root cert&quot;
</span></code></pre></div>
</div>


  




                
              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var tab,labels=set.querySelector(".tabbed-labels");for(tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
    
      
      <nav class="md-footer__inner md-grid" aria-label="Footer" >
        
          
          <a href="../indexing/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Indexing">
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Previous
              </span>
              <div class="md-ellipsis">
                Indexing
              </div>
            </div>
          </a>
        
        
          
          <a href="../intra-device-sync/" class="md-footer__link md-footer__link--next" aria-label="Next: Intra-device Sync">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Next
              </span>
              <div class="md-ellipsis">
                Intra-device Sync
              </div>
            </div>
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      &copy; 2023 Jeff Lockhart
    </div>
  
  
</div>
      
        <div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://github.com/jeffdgr8" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://twitter.com/jeffdgr8" target="_blank" rel="noopener" title="twitter.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18.901 1.153h3.68l-8.04 9.19L24 22.846h-7.406l-5.8-7.584-6.638 7.584H.474l8.6-9.83L0 1.154h7.594l5.243 6.932ZM17.61 20.644h2.039L6.486 3.24H4.298Z"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://linkedin.com/in/lockhartjeff/" target="_blank" rel="noopener" title="linkedin.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433a2.062 2.062 0 0 1-2.063-2.065 2.064 2.064 0 1 1 2.063 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "..", "features": ["content.code.copy", "content.tabs.link", "navigation.footer", "navigation.instant", "navigation.tabs", "navigation.top", "navigation.tracking", "search.suggest", "toc.follow"], "search": "../assets/javascripts/workers/search.f886a092.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": "3.0.12-1.0.0"}</script>
    
    
      <script src="../assets/javascripts/bundle.aecac24b.min.js"></script>
      
    
  </body>
</html>