
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Kotlin Multiplatform library for Couchbase Lite—a lightweight, embedded, syncable, NoSQL database">
      
      
        <meta name="author" content="Jeff Lockhart">
      
      
        <link rel="canonical" href="https://kotbase.dev/active-peer/">
      
      
        <link rel="prev" href="../passive-peer/">
      
      
        <link rel="next" href="../integrate-custom-listener/">
      
      
      <link rel="icon" href="../assets/images/couchbase-logo.svg">
      <meta name="generator" content="mkdocs-1.5.3, mkdocs-material-9.5.2">
    
    
      
        <title>Active Peer - Kotbase</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.50c56a3b.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.06af60db.min.css">
      
      
  
  
    
    
  
    
    
  
  
  <style>:root{--md-admonition-icon--link:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1M8 13h8v-2H8v2m9-6h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1 0 1.71-1.39 3.1-3.1 3.1h-4V17h4a5 5 0 0 0 5-5 5 5 0 0 0-5-5Z"/></svg>');--md-admonition-icon--important:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 6a6 6 0 0 1 6 6c0 2.22-1.21 4.16-3 5.2V19a1 1 0 0 1-1 1h-4a1 1 0 0 1-1-1v-1.8c-1.79-1.04-3-2.98-3-5.2a6 6 0 0 1 6-6m2 15v1a1 1 0 0 1-1 1h-2a1 1 0 0 1-1-1v-1h4m6-10h3v2h-3v-2M1 11h3v2H1v-2M13 1v3h-2V1h2M4.92 3.5l2.13 2.14-1.42 1.41L3.5 4.93 4.92 3.5m12.03 2.13 2.12-2.13 1.43 1.43-2.13 2.12-1.42-1.42Z"/></svg>');}</style>



    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=DM+Sans:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"DM Sans";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/permalink.css">
    
      <link rel="stylesheet" href="../assets/stylesheets/extra.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  
  

<script id="__analytics">function __md_analytics(){function n(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],n("js",new Date),n("config","G-QFS8SG5ZKD"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){this.value&&n("event","search",{search_term:this.value})}),document$.subscribe(function(){var a=document.forms.feedback;if(void 0!==a)for(var e of a.querySelectorAll("[type=submit]"))e.addEventListener("click",function(e){e.preventDefault();var t=document.location.pathname,e=this.getAttribute("data-md-value");n("event","feedback",{page:t,data:e}),a.firstElementChild.disabled=!0;e=a.querySelector(".md-feedback__note [data-md-value='"+e+"']");e&&(e.hidden=!1)}),a.hidden=!1}),location$.subscribe(function(e){n("config","G-QFS8SG5ZKD",{page_path:e.pathname})})});var e=document.createElement("script");e.async=!0,e.src="https://www.googletagmanager.com/gtag/js?id=G-QFS8SG5ZKD",document.getElementById("__analytics").insertAdjacentElement("afterEnd",e)}</script>
  
    <script>"undefined"!=typeof __md_analytics&&__md_analytics()</script>
  

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="white" data-md-color-accent="red">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#introduction" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <div data-md-color-scheme="default" data-md-component="outdated" hidden>
        
      </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Kotbase" class="md-header__button md-logo" aria-label="Kotbase" data-md-component="logo">
      
  <img src="../assets/images/couchbase-logo.svg" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Kotbase
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Active Peer
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="white" data-md-color-accent="red"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="black" data-md-color-accent="red"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12c0-2.42-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var media,input,key,value,palette=__md_get("__palette");if(palette&&palette.color){"(prefers-color-scheme)"===palette.color.media&&(media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']"),palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent"));for([key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/jeffdgr8/kotbase" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    Kotbase
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href=".." class="md-tabs__link">
          
  
  Overview

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../installation/" class="md-tabs__link">
          
  
  Getting Started

        </a>
      </li>
    
  

      
        
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../databases/" class="md-tabs__link">
          
  
  Documentation

        </a>
      </li>
    
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../api" target="_blank" class="md-tabs__link">
        
  
    
  
  API Reference

      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Kotbase" class="md-nav__button md-logo" aria-label="Kotbase" data-md-component="logo">
      
  <img src="../assets/images/couchbase-logo.svg" alt="logo">

    </a>
    Kotbase
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/jeffdgr8/kotbase" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    Kotbase
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1" >
        
          
          <label class="md-nav__link" for="__nav_1" id="__nav_1_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Overview
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_1">
            <span class="md-nav__icon md-icon"></span>
            Overview
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Kotbase
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../differences/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Differences from Java SDK
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../roadmap/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Roadmap
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../changelog/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Change Log
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../community/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Community
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../license/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    License
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Getting Started
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Getting Started
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../installation/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Installation
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../platforms/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Supported Platforms
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../getting-started/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Build and Run
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_4" >
        
          
          <label class="md-nav__link" for="__nav_2_4" id="__nav_2_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Extension Libraries
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_4">
            <span class="md-nav__icon md-icon"></span>
            Extension Libraries
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ktx/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    KTX
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../kermit/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Kermit
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../paging/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Paging
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" checked>
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Documentation
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Documentation
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../databases/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Databases
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../prebuilt-database/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Pre-built Database
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../documents/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Documents
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../blobs/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Blobs
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_5" >
        
          
          <label class="md-nav__link" for="__nav_3_5" id="__nav_3_5_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Query
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_5">
            <span class="md-nav__icon md-icon"></span>
            Query
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../query-builder/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    QueryBuilder
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../n1ql-query-strings/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    SQL++ Query Strings
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../n1ql-server-differences/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    SQL++ Server Differences
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../n1ql-query-builder-differences/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    SQL++ QueryBuilder Differences
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../query-result-sets/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Query Result Sets
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../live-queries/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Live Queries
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../query-troubleshooting/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Query Troubleshooting
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../full-text-search/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Full Text Search
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../indexing/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Indexing
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_8" checked>
        
          
          <label class="md-nav__link" for="__nav_3_8" id="__nav_3_8_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Data Sync
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_8_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3_8">
            <span class="md-nav__icon md-icon"></span>
            Data Sync
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../remote-sync-gateway/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Remote Sync Gateway
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../intra-device-sync/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Intra-device Sync
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_8_3" checked>
        
          
          <label class="md-nav__link" for="__nav_3_8_3" id="__nav_3_8_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Peer-to-Peer
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_3_8_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3_8_3">
            <span class="md-nav__icon md-icon"></span>
            Peer-to-Peer
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../peer-to-peer-sync/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Peer-to-Peer Sync
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../passive-peer/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Passive Peer
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Active Peer
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Active Peer
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#introduction" class="md-nav__link">
    <span class="md-ellipsis">
      Introduction
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#configuration-summary" class="md-nav__link">
    <span class="md-ellipsis">
      Configuration Summary
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#device-discovery" class="md-nav__link">
    <span class="md-ellipsis">
      Device Discovery
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#configure-replicator" class="md-nav__link">
    <span class="md-ellipsis">
      Configure Replicator
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Configure Replicator">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#configure-target" class="md-nav__link">
    <span class="md-ellipsis">
      Configure Target
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sync-mode" class="md-nav__link">
    <span class="md-ellipsis">
      Sync Mode
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#retry-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      Retry Configuration
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#authenticating-the-listener" class="md-nav__link">
    <span class="md-ellipsis">
      Authenticating the Listener
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#client-authentication" class="md-nav__link">
    <span class="md-ellipsis">
      Client Authentication
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Client Authentication">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#basic-authentication" class="md-nav__link">
    <span class="md-ellipsis">
      Basic Authentication
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#certificate-authentication" class="md-nav__link">
    <span class="md-ellipsis">
      Certificate Authentication
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#initialize-replicator" class="md-nav__link">
    <span class="md-ellipsis">
      Initialize Replicator
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#monitor-sync" class="md-nav__link">
    <span class="md-ellipsis">
      Monitor Sync
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Monitor Sync">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#change-listeners" class="md-nav__link">
    <span class="md-ellipsis">
      Change Listeners
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Change Listeners">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#using-kotlin-flows" class="md-nav__link">
    <span class="md-ellipsis">
      Using Kotlin Flows
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#replicator-status" class="md-nav__link">
    <span class="md-ellipsis">
      Replicator Status
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Replicator Status">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#replication-states" class="md-nav__link">
    <span class="md-ellipsis">
      Replication States
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#replication-status-and-app-life-cycle" class="md-nav__link">
    <span class="md-ellipsis">
      Replication Status and App Life Cycle
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Replication Status and App Life Cycle">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ios" class="md-nav__link">
    <span class="md-ellipsis">
      iOS
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#other-platforms" class="md-nav__link">
    <span class="md-ellipsis">
      Other Platforms
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#documents-pending-push" class="md-nav__link">
    <span class="md-ellipsis">
      Documents Pending Push
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#stop-sync" class="md-nav__link">
    <span class="md-ellipsis">
      Stop Sync
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#conflict-resolution" class="md-nav__link">
    <span class="md-ellipsis">
      Conflict Resolution
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#delta-sync" class="md-nav__link">
    <span class="md-ellipsis">
      Delta Sync
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../integrate-custom-listener/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Integrate Custom Listener
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../handling-data-conflicts/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Handling Data Conflicts
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../using-logs/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Using Logs
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../kotlin-extensions/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Kotlin Extensions
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../api" target="_blank" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    API Reference
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#introduction" class="md-nav__link">
    <span class="md-ellipsis">
      Introduction
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#configuration-summary" class="md-nav__link">
    <span class="md-ellipsis">
      Configuration Summary
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#device-discovery" class="md-nav__link">
    <span class="md-ellipsis">
      Device Discovery
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#configure-replicator" class="md-nav__link">
    <span class="md-ellipsis">
      Configure Replicator
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Configure Replicator">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#configure-target" class="md-nav__link">
    <span class="md-ellipsis">
      Configure Target
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sync-mode" class="md-nav__link">
    <span class="md-ellipsis">
      Sync Mode
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#retry-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      Retry Configuration
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#authenticating-the-listener" class="md-nav__link">
    <span class="md-ellipsis">
      Authenticating the Listener
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#client-authentication" class="md-nav__link">
    <span class="md-ellipsis">
      Client Authentication
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Client Authentication">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#basic-authentication" class="md-nav__link">
    <span class="md-ellipsis">
      Basic Authentication
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#certificate-authentication" class="md-nav__link">
    <span class="md-ellipsis">
      Certificate Authentication
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#initialize-replicator" class="md-nav__link">
    <span class="md-ellipsis">
      Initialize Replicator
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#monitor-sync" class="md-nav__link">
    <span class="md-ellipsis">
      Monitor Sync
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Monitor Sync">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#change-listeners" class="md-nav__link">
    <span class="md-ellipsis">
      Change Listeners
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Change Listeners">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#using-kotlin-flows" class="md-nav__link">
    <span class="md-ellipsis">
      Using Kotlin Flows
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#replicator-status" class="md-nav__link">
    <span class="md-ellipsis">
      Replicator Status
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Replicator Status">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#replication-states" class="md-nav__link">
    <span class="md-ellipsis">
      Replication States
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#replication-status-and-app-life-cycle" class="md-nav__link">
    <span class="md-ellipsis">
      Replication Status and App Life Cycle
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Replication Status and App Life Cycle">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ios" class="md-nav__link">
    <span class="md-ellipsis">
      iOS
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#other-platforms" class="md-nav__link">
    <span class="md-ellipsis">
      Other Platforms
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#documents-pending-push" class="md-nav__link">
    <span class="md-ellipsis">
      Documents Pending Push
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#stop-sync" class="md-nav__link">
    <span class="md-ellipsis">
      Stop Sync
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#conflict-resolution" class="md-nav__link">
    <span class="md-ellipsis">
      Conflict Resolution
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#delta-sync" class="md-nav__link">
    <span class="md-ellipsis">
      Delta Sync
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


  <h1>Active Peer</h1>

<p><em>How to set up a replicator to connect with a listener and replicate changes using peer-to-peer sync</em></p>
<div class="admonition warning">
<p class="admonition-title">Android enablers</p>
<p><strong>Allow Unencrypted Network Traffic</strong></p>
<p>To use cleartext, un-encrypted, network traffic (<code>http://</code> and-or <code>ws://</code>), include
<code>android:usesCleartextTraffic="true"</code> in the <code>application</code> element of the manifest as shown on
<a href="https://developer.android.com/training/articles/security-config#CleartextTrafficPermitted">developer.android.com</a>.<br />
<strong>This not recommended in production.</strong></p>
</div>
<div class="admonition warning">
<p class="admonition-title">Use Background Threads</p>
<p>As with any network or file I/O activity, Couchbase Lite activities should not be performed on the UI thread.
<strong>Always</strong> use a <strong>background</strong> thread.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Code Snippets</p>
<p>All code examples are indicative only. They demonstrate the basic concepts and approaches to using a feature. Use
them as inspiration and adapt these examples to best practice when developing applications for your platform.</p>
</div>
<h2 id="introduction">Introduction<a class="headerlink" href="#introduction" title="Permanent link"></a></h2>
<div class="admonition important">
<p class="admonition-title">This is an <a href="https://www.couchbase.com/products/editions">Enterprise Edition</a> feature.</p>
</div>
<p>This content provides sample code and configuration examples covering the implementation of Peer-to-Peer Sync over
WebSockets. Specifically it covers the implementation of an Active Peer.</p>
<p>This active peer (also referred to as a client and-or a replicator) will initiate the connection with a Passive Peer
(also referred to as a server and-or listener) and participate in the replication of database changes to bring both
databases into sync.</p>
<p>Subsequent sections provide additional details and examples for the main configuration options.</p>
<div class="admonition note">
<p class="admonition-title">Secure Storage</p>
<p>The use of TLS, its associated keys and certificates requires using secure storage to minimize the chances of a
security breach. The implementation of this storage differs from platform to platform — see <a href="../peer-to-peer-sync/#using-secure-storage">Using Secure Storage</a>.</p>
</div>
<h2 id="configuration-summary">Configuration Summary<a class="headerlink" href="#configuration-summary" title="Permanent link"></a></h2>
<p>You should configure and initialize a replicator for each Couchbase Lite database instance you want to sync. <a href="#example-1">Example 1
</a> shows the initialization and configuration process.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>As with any network or file I/O activity, Couchbase Lite activities should not be performed on the UI thread.
<strong>Always</strong> use a <strong>background</strong> thread.</p>
</div>
<div class="admonition example">
<p class="admonition-title"><span id='example-1'>Example 1. Replication configuration and initialization</span></p>
<div class="language-kotlin highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="kd">val</span><span class="w"> </span><span class="nv">repl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Replicator</span><span class="p">(</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a><span class="w">    </span><span class="c1">// initialize the replicator configuration</span>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="w">    </span><span class="n">ReplicatorConfigurationFactory</span><span class="p">.</span><span class="na">newConfig</span><span class="p">(</span>
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="w">        </span><span class="n">database</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">database</span><span class="p">,</span>
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="w">        </span><span class="n">target</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">URLEndpoint</span><span class="p">(</span><span class="s">&quot;wss://listener.com:8954&quot;</span><span class="p">),</span>
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a><span class="w">        </span><span class="c1">// Set replicator type</span>
</span><span id="__span-0-9"><a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a><span class="w">        </span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ReplicatorType</span><span class="p">.</span><span class="na">PUSH_AND_PULL</span><span class="p">,</span>
</span><span id="__span-0-10"><a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>
</span><span id="__span-0-11"><a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a><span class="w">        </span><span class="c1">// Configure Sync Mode</span>
</span><span id="__span-0-12"><a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a><span class="w">        </span><span class="n">continuous</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="c1">// default value</span>
</span><span id="__span-0-13"><a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>
</span><span id="__span-0-14"><a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a><span class="w">        </span><span class="c1">// Configure Server Authentication --</span>
</span><span id="__span-0-15"><a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a><span class="w">        </span><span class="c1">// only accept self-signed certs</span>
</span><span id="__span-0-16"><a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a><span class="w">        </span><span class="n">acceptOnlySelfSignedServerCertificate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
</span><span id="__span-0-17"><a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>
</span><span id="__span-0-18"><a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a><span class="w">        </span><span class="c1">// Configure the credentials the</span>
</span><span id="__span-0-19"><a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a><span class="w">        </span><span class="c1">// client will provide if prompted</span>
</span><span id="__span-0-20"><a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a><span class="w">        </span><span class="n">authenticator</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BasicAuthenticator</span><span class="p">(</span><span class="s">&quot;PRIVUSER&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;let me in&quot;</span><span class="p">.</span><span class="na">toCharArray</span><span class="p">()),</span>
</span><span id="__span-0-21"><a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a>
</span><span id="__span-0-22"><a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a><span class="w">        </span><span class="n">conflictResolver</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ReplicatorConfiguration</span><span class="p">.</span><span class="na">DEFAULT_CONFLICT_RESOLVER</span>
</span><span id="__span-0-23"><a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a><span class="w">    </span><span class="p">)</span>
</span><span id="__span-0-24"><a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a><span class="p">)</span>
</span><span id="__span-0-25"><a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a>
</span><span id="__span-0-26"><a id="__codelineno-0-26" name="__codelineno-0-26" href="#__codelineno-0-26"></a><span class="c1">// Optionally add a change listener</span>
</span><span id="__span-0-27"><a id="__codelineno-0-27" name="__codelineno-0-27" href="#__codelineno-0-27"></a><span class="kd">val</span><span class="w"> </span><span class="nv">token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">repl</span><span class="p">.</span><span class="na">addChangeListener</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">change</span><span class="w"> </span><span class="o">-&gt;</span>
</span><span id="__span-0-28"><a id="__codelineno-0-28" name="__codelineno-0-28" href="#__codelineno-0-28"></a><span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">err</span><span class="p">:</span><span class="w"> </span><span class="n">CouchbaseLiteException? </span><span class="o">=</span><span class="w"> </span><span class="n">change</span><span class="p">.</span><span class="na">status</span><span class="p">.</span><span class="na">error</span>
</span><span id="__span-0-29"><a id="__codelineno-0-29" name="__codelineno-0-29" href="#__codelineno-0-29"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-0-30"><a id="__codelineno-0-30" name="__codelineno-0-30" href="#__codelineno-0-30"></a><span class="w">        </span><span class="n">println</span><span class="p">(</span><span class="s">&quot;Error code ::  </span><span class="si">${</span><span class="n">err</span><span class="p">.</span><span class="na">code</span><span class="si">}</span><span class="s">\n</span><span class="si">$</span><span class="n">err</span><span class="s">&quot;</span><span class="p">)</span>
</span><span id="__span-0-31"><a id="__codelineno-0-31" name="__codelineno-0-31" href="#__codelineno-0-31"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-0-32"><a id="__codelineno-0-32" name="__codelineno-0-32" href="#__codelineno-0-32"></a><span class="p">}</span>
</span><span id="__span-0-33"><a id="__codelineno-0-33" name="__codelineno-0-33" href="#__codelineno-0-33"></a>
</span><span id="__span-0-34"><a id="__codelineno-0-34" name="__codelineno-0-34" href="#__codelineno-0-34"></a><span class="c1">// Start replicator</span>
</span><span id="__span-0-35"><a id="__codelineno-0-35" name="__codelineno-0-35" href="#__codelineno-0-35"></a><span class="n">repl</span><span class="p">.</span><span class="na">start</span><span class="p">(</span><span class="kc">false</span><span class="p">)</span>
</span><span id="__span-0-36"><a id="__codelineno-0-36" name="__codelineno-0-36" href="#__codelineno-0-36"></a>
</span><span id="__span-0-37"><a id="__codelineno-0-37" name="__codelineno-0-37" href="#__codelineno-0-37"></a><span class="k">this</span><span class="p">.</span><span class="na">replicator</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">repl</span>
</span><span id="__span-0-38"><a id="__codelineno-0-38" name="__codelineno-0-38" href="#__codelineno-0-38"></a><span class="k">this</span><span class="p">.</span><span class="na">token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">token</span>
</span></code></pre></div>
</div>
<ol>
<li>Configure how the client will authenticate the server. Here we say connect only to servers presenting a self-signed
   certificate. By default, clients accept only servers presenting certificates that can be verified using the OS
   bundled Root CA Certificates — see <a href="#authenticating-the-listener">Authenticating the Listener</a>.</li>
<li>Configure the credentials the client will present to the server. Here we say to provide <em>Basic Authentication</em>
   credentials. Other options are available — see <a href="#example-7">Example 7</a>.</li>
<li>Configure how the replication should perform <a href="#conflict-resolution">Conflict Resolution</a>.</li>
<li>Initialize the replicator using your configuration object.</li>
<li>Register an observer, which will notify you of changes to the replication status.</li>
<li>Start the replicator.</li>
</ol>
<h2 id="device-discovery">Device Discovery<a class="headerlink" href="#device-discovery" title="Permanent link"></a></h2>
<p><strong>This phase is optional:</strong> If the listener is initialized on a well known URL endpoint (for example, a static IP
address or well-known DNS address) then you can configure Active Peers to connect to those.</p>
<p>Prior to connecting with a listener you may execute a peer discovery phase to dynamically discover peers.</p>
<p>For the Active Peer this involves browsing-for and selecting the appropriate service using a zero-config protocol such
as <a href="https://developer.android.com/training/connect-devices-wirelessly/nsd">Network Service Discovery on Android</a> or
<a href="https://developer.apple.com/bonjour/">Bonjour on iOS</a>.</p>
<h2 id="configure-replicator">Configure Replicator<a class="headerlink" href="#configure-replicator" title="Permanent link"></a></h2>
<p><strong>In this section</strong><br />
<a href="#configure-target">Configure Target</a> | <a href="#sync-mode">Sync Mode</a> | <a href="#retry-configuration">Retry Configuration</a> |
<a href="#authenticating-the-listener">Authenticating the Listener</a> | <a href="#client-authentication">Client Authentication</a></p>
<h3 id="configure-target">Configure Target<a class="headerlink" href="#configure-target" title="Permanent link"></a></h3>
<p>Initialize and define the replication configuration with local and remote database locations using the
<a href="/api/couchbase-lite-ee/kotbase/-replicator-configuration/"><code>ReplicatorConfiguration</code></a> object.</p>
<p>The constructor provides:</p>
<ul>
<li>The name of the local database to be sync’d</li>
<li>The server’s URL (including the port number and the name of the remote database to sync with)<br><br>
  It is expected that the app will identify the IP address and URL and append the remote database name to the URL
  endpoint, producing for example: <code>wss://10.0.2.2:4984/travel-sample</code><br><br>
  The URL scheme for WebSocket URLs uses <code>ws:</code> (non-TLS) or <code>wss:</code> (SSL/TLS) prefixes.</li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>On the Android platform, to use cleartext, un-encrypted, network traffic (<code>http://</code> and-or <code>ws://</code>), include
<code>android:usesCleartextTraffic="true"</code> in the <code>application</code> element of the manifest as shown on
<a href="https://developer.android.com/training/articles/security-config#CleartextTrafficPermitted">developer.android.com</a>.<br />
<strong>This not recommended in production.</strong></p>
</div>
<div class="admonition example">
<p class="admonition-title">Example 2. Add Target to Configuration</p>
<div class="language-kotlin highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="c1">// initialize the replicator configuration</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a><span class="kd">val</span><span class="w"> </span><span class="nv">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ReplicatorConfigurationFactory</span><span class="p">.</span><span class="na">newConfig</span><span class="p">(</span>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a><span class="w">    </span><span class="n">database</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">database</span><span class="p">,</span>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a><span class="w">    </span><span class="n">target</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">URLEndpoint</span><span class="p">(</span><span class="s">&quot;wss://10.0.2.2:8954/travel-sample&quot;</span><span class="p">),</span>
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a><span class="p">)</span>
</span></code></pre></div>
</div>
<p>Note use of the scheme prefix (<code>wss://</code> to ensure TLS encryption — strongly recommended in production — or <code>ws://</code>).</p>
<h3 id="sync-mode">Sync Mode<a class="headerlink" href="#sync-mode" title="Permanent link"></a></h3>
<p>Here we define the direction and type of replication we want to initiate.</p>
<p>We use <a href="/api/couchbase-lite-ee/kotbase/-replicator-configuration/"><code>ReplicatorConfiguration</code></a> class’s <a href="/api/couchbase-lite-ee/kotbase/-replicator-configuration/type.html"><code>type</code></a> and <a href="/api/couchbase-lite-ee/kotbase/-replicator-configuration/is-continuous.html"><code>isContinuous</code></a> properties to tell the replicator:</p>
<ul>
<li>The type (or direction) of the replication: <code>PUSH_AND_PULL</code>; <code>PULL</code>; <code>PUSH</code></li>
<li>The replication mode, that is either of:<ul>
<li>Continuous — remaining active indefinitely to replicate changed documents (<code>isContinuous=true</code>).</li>
<li>Ad-hoc — a one-shot replication of changed documents (<code>isContinuous=false</code>).</li>
</ul>
</li>
</ul>
<div class="admonition example">
<p class="admonition-title">Example 3. Configure replicator type and mode</p>
<div class="language-kotlin highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="c1">// Set replicator type</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ReplicatorType</span><span class="p">.</span><span class="na">PUSH_AND_PULL</span><span class="p">,</span>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a>
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a><span class="c1">// Configure Sync Mode</span>
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a><span class="n">continuous</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="c1">// default value</span>
</span></code></pre></div>
</div>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Unless there is a solid use-case not to, always initiate a single <code>PUSH_AND_PULL</code> replication rather than identical
separate <code>PUSH</code> and <code>PULL</code> replications.</p>
<p>This prevents the replications generating the same checkpoint <code>docID</code> resulting in multiple conflicts.</p>
</div>
<h3 id="retry-configuration">Retry Configuration<a class="headerlink" href="#retry-configuration" title="Permanent link"></a></h3>
<p>Couchbase Lite’s replication retry logic assures a resilient connection.</p>
<p>The replicator minimizes the chance and impact of dropped connections by maintaining a heartbeat; essentially pinging
the listener at a configurable interval to ensure the connection remains alive.</p>
<p>In the event it detects a transient error, the replicator will attempt to reconnect, stopping only when the connection
is re-established, or the number of retries exceeds the retry limit (9 times for a single-shot replication and unlimited
for a continuous replication).</p>
<p>On each retry the interval between attempts is increased exponentially (exponential backoff) up to the maximum wait time
limit (5 minutes).</p>
<p>The REST API provides configurable control over this replication retry logic using a set of configurable properties —
see <a href="#table-1">Table 1</a>.</p>
<p><strong>Table 1. Replication Retry Configuration Properties</strong></p>
<table>
<thead>
<tr>
<th style="text-align: left;"><div style="min-width:173px">Property</div></th>
<th style="text-align: left;">Use cases</th>
<th style="text-align: left;">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><a href="/api/couchbase-lite-ee/kotbase/-replicator-configuration/set-heartbeat.html"><code>setHeartbeat()</code></a></td>
<td style="text-align: left;"><ul><li>Reduce to detect connection errors sooner</li><li>Align to load-balancer or proxy <code>keep-alive</code> interval — see Sync Gateway’s topic <a href="https://docs.couchbase.com/sync-gateway/current/load-balancer.html#websocket-connection">Load Balancer - Keep Alive</a></li></ul></td>
<td style="text-align: left;">The interval (in seconds) between the heartbeat pulses.<br><br>Default: The replicator pings the listener every 300 seconds.</td>
</tr>
<tr>
<td style="text-align: left;"><a href="/api/couchbase-lite-ee/kotbase/-replicator-configuration/set-max-attempts.html"><code>setMaxAttempts()</code></a></td>
<td style="text-align: left;">Change this to limit or extend the number of retry attempts.</td>
<td style="text-align: left;">The maximum number of retry attempts<ul><li>Set to zero (0) to use default values</li><li>Set to one (1) to prevent any retry attempt</li><li>The retry attempt count is reset when the replicator is able to connect and replicate</li><li>Default values are:<ul><li>Single-shot replication = 9;</li><li>Continuous replication = maximum integer value</li></ul></li><li>Negative values generate a Couchbase exception <code>InvalidArgumentException</code></li></ul></td>
</tr>
<tr>
<td style="text-align: left;"><a href="/api/couchbase-lite-ee/kotbase/-replicator-configuration/set-max-attempt-wait-time.html"><code>setMaxAttemptWaitTime()</code></a></td>
<td style="text-align: left;">Change this to adjust the interval between retries.</td>
<td style="text-align: left;">The maximum interval between retry attempts<br><br>While you can configure the <strong>maximum permitted</strong> wait time, the replicator’s exponential backoff algorithm calculates each individual interval which is not configurable.<ul><li>Default value: 300 seconds (5 minutes)</li><li>Zero sets the maximum interval between retries to the default of 300 seconds</li><li>300 sets the maximum interval between retries to the default of 300 seconds</li><li>A negative value generates a Couchbase exception, <code>InvalidArgumentException</code></li></ul></td>
</tr>
</tbody>
</table>
<p>When necessary you can adjust any or all of those configurable values — see <a href="#example-4">Example 4</a> for how to do this.</p>
<div class="admonition example">
<p class="admonition-title"><span id='example-4'>Example 4. Configuring Replication Retries</span></p>
<div class="language-kotlin highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="kd">val</span><span class="w"> </span><span class="nv">repl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Replicator</span><span class="p">(</span>
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a><span class="w">    </span><span class="n">ReplicatorConfigurationFactory</span><span class="p">.</span><span class="na">newConfig</span><span class="p">(</span>
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a><span class="w">        </span><span class="n">database</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">database</span><span class="p">,</span>
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a><span class="w">        </span><span class="n">target</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">URLEndpoint</span><span class="p">(</span><span class="s">&quot;ws://localhost:4984/mydatabase&quot;</span><span class="p">),</span>
</span><span id="__span-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a><span class="w">        </span><span class="c1">//  other config params as required . .</span>
</span><span id="__span-3-6"><a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a><span class="w">        </span><span class="n">heartbeat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">150</span><span class="p">,</span><span class="w"> </span>
</span><span id="__span-3-7"><a id="__codelineno-3-7" name="__codelineno-3-7" href="#__codelineno-3-7"></a><span class="w">        </span><span class="n">maxAttempts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">20</span><span class="p">,</span>
</span><span id="__span-3-8"><a id="__codelineno-3-8" name="__codelineno-3-8" href="#__codelineno-3-8"></a><span class="w">        </span><span class="n">maxAttemptWaitTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">600</span>
</span><span id="__span-3-9"><a id="__codelineno-3-9" name="__codelineno-3-9" href="#__codelineno-3-9"></a><span class="w">    </span><span class="p">)</span>
</span><span id="__span-3-10"><a id="__codelineno-3-10" name="__codelineno-3-10" href="#__codelineno-3-10"></a><span class="p">)</span>
</span><span id="__span-3-11"><a id="__codelineno-3-11" name="__codelineno-3-11" href="#__codelineno-3-11"></a><span class="n">repl</span><span class="p">.</span><span class="na">start</span><span class="p">()</span>
</span><span id="__span-3-12"><a id="__codelineno-3-12" name="__codelineno-3-12" href="#__codelineno-3-12"></a><span class="k">this</span><span class="p">.</span><span class="na">replicator</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">repl</span>
</span></code></pre></div>
</div>
<h3 id="authenticating-the-listener">Authenticating the Listener<a class="headerlink" href="#authenticating-the-listener" title="Permanent link"></a></h3>
<p>Define the credentials your app (the client) is expecting to receive from the server (listener) in order to ensure that
the server is one it is prepared to interact with.</p>
<p>Note that the client cannot authenticate the server if TLS is turned off. When TLS is enabled (listener’s default) the
client must authenticate the server. If the server cannot provide acceptable credentials then the connection will fail.</p>
<p>Use <a href="/api/couchbase-lite-ee/kotbase/-replicator-configuration/"><code>ReplicatorConfiguration</code></a> properties
<a href="/api/couchbase-lite-ee/kotbase/set-accept-only-self-signed-server-certificate.html"><code>setAcceptOnlySelfSignedServerCertificate</code></a> and <a href="/api/couchbase-lite-ee/kotbase/-replicator-configuration/set-pinned-server-certificate.html"><code>setPinnedServerCertificate</code></a>, to tell the replicator how
to verify server-supplied TLS server certificates.</p>
<ul>
<li>If there is a pinned certificate, nothing else matters, the server cert must <strong>exactly</strong> match the pinned certificate.</li>
<li>If there are no pinned certs and <a href="/api/couchbase-lite-ee/kotbase/set-accept-only-self-signed-server-certificate.html"><code>setAcceptOnlySelfSignedServerCertificate</code></a> is <code>true</code> then any self-signed
  certificate is accepted. Certificates that are not self-signed are rejected, no matter who signed them.</li>
<li>If there are no pinned certificates and <a href="/api/couchbase-lite-ee/kotbase/set-accept-only-self-signed-server-certificate.html"><code>setAcceptOnlySelfSignedServerCertificate</code></a> is <code>false</code> (default), the client
  validates the server’s certificates against the system CA certificates. The server must supply a chain of certificates
  whose root is signed by one of the certificates in the system CA bundle.</li>
</ul>
<div class="admonition example">
<p class="admonition-title">Example 5. Set Server TLS security</p>
<div class="tabbed-set tabbed-alternate" data-tabs="1:3"><input checked="checked" id="__tabbed_1_1" name="__tabbed_1" type="radio" /><input id="__tabbed_1_2" name="__tabbed_1" type="radio" /><input id="__tabbed_1_3" name="__tabbed_1" type="radio" /><div class="tabbed-labels"><label for="__tabbed_1_1">CA Cert</label><label for="__tabbed_1_2">Self-Signed Cert</label><label for="__tabbed_1_3">Pinned Certificate</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p>Set the client to expect and accept only CA attested certificates.</p>
<div class="language-kotlin highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="c1">// Configure Server Security</span>
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a><span class="c1">// -- only accept CA attested certs</span>
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a><span class="n">acceptOnlySelfSignedServerCertificate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span>
</span></code></pre></div>
<p>This is the default. Only certificate chains with roots signed by a trusted CA are allowed. Self-signed
certificates are not allowed.</p>
</div>
<div class="tabbed-block">
<p>Set the client to expect and accept only self-signed certificates.</p>
<div class="language-kotlin highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="c1">// Configure Server Authentication --</span>
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a><span class="c1">// only accept self-signed certs</span>
</span><span id="__span-5-3"><a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a><span class="n">acceptOnlySelfSignedServerCertificate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
</span></code></pre></div>
<p>Set this to <code>true</code> to accept any self-signed cert. Any certificates that are not self-signed are rejected.</p>
</div>
<div class="tabbed-block">
<p>Set the client to expect and accept only a pinned certificate.</p>
<div class="language-kotlin highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="c1">// Use the pinned certificate from the byte array (cert)</span>
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a><span class="n">pinnedServerCertificate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TLSIdentity</span><span class="p">.</span><span class="na">getIdentity</span><span class="p">(</span><span class="s">&quot;Our Corporate Id&quot;</span><span class="p">)</span>
</span><span id="__span-6-3"><a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a><span class="w">    </span><span class="o">?.</span><span class="na">certs</span><span class="o">?.</span><span class="na">firstOrNull</span><span class="p">()</span>
</span><span id="__span-6-4"><a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a><span class="w">    </span><span class="o">?:</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="n">IllegalStateException</span><span class="p">(</span><span class="s">&quot;Cannot find corporate id&quot;</span><span class="p">),</span>
</span></code></pre></div>
<p>Configure the pinned certificate using data from the byte array <code>cert</code></p>
</div>
</div>
</div>
</div>
<h3 id="client-authentication">Client Authentication<a class="headerlink" href="#client-authentication" title="Permanent link"></a></h3>
<p>Here we define the credentials that the client can present to the server if prompted to do so in order that the server
can authenticate it.</p>
<p>We use <a href="/api/couchbase-lite-ee/kotbase/-replicator-configuration/"><code>ReplicatorConfiguration</code></a>'s <a href="/api/couchbase-lite-ee/kotbase/-replicator-configuration/authenticator.html"><code>authenticator</code></a> property to define the authentication
method to the replicator.</p>
<h4 id="basic-authentication">Basic Authentication<a class="headerlink" href="#basic-authentication" title="Permanent link"></a></h4>
<p>Use the <a href="/api/couchbase-lite-ee/kotbase/-basic-authenticator/"><code>BasicAuthenticator</code></a> to supply basic authentication
credentials (username and password).</p>
<div class="admonition example">
<p class="admonition-title">Example 6. Basic Authentication</p>
<p>This example shows basic authentication using username and password:</p>
<div class="language-kotlin highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="c1">// Configure the credentials the</span>
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a><span class="c1">// client will provide if prompted</span>
</span><span id="__span-7-3"><a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a><span class="n">authenticator</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BasicAuthenticator</span><span class="p">(</span><span class="s">&quot;PRIVUSER&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;let me in&quot;</span><span class="p">.</span><span class="na">toCharArray</span><span class="p">())</span>
</span></code></pre></div>
</div>
<h4 id="certificate-authentication">Certificate Authentication<a class="headerlink" href="#certificate-authentication" title="Permanent link"></a></h4>
<p>Use the <a href="/api/couchbase-lite-ee/kotbase/-client-certificate-authenticator/"><code>ClientCertificateAuthenticator</code></a> to
configure the client TLS certificates to be presented to the server, on connection. This applies only to the
<a href="/api/couchbase-lite-ee/kotbase/-u-r-l-endpoint-listener/"><code>URLEndpointListener</code></a>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The server (listener) must have <code>isTlsDisabled</code> set to <code>false</code> and have a <a href="/api/couchbase-lite-ee/kotbase/-listener-certificate-authenticator/"><code>ListenerCertificateAuthenticator</code></a> configured, or it will never ask for this
client’s certificate.</p>
</div>
<p>The certificate to be presented to the server will need to be signed by the root certificates or be valid based on the
authentication callback set to the listener via <a href="/api/couchbase-lite-ee/kotbase/-listener-certificate-authenticator/"><code>ListenerCertificateAuthenticator</code></a>.</p>
<div class="admonition example">
<p class="admonition-title">Example 7. Client Cert Authentication</p>
<p>This example shows client certificate authentication using an identity from secure storage.</p>
<div class="language-kotlin highlight"><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="c1">// Provide a client certificate to the server for authentication</span>
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a><span class="n">authenticator</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ClientCertificateAuthenticator</span><span class="p">(</span>
</span><span id="__span-8-3"><a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a><span class="w">    </span><span class="n">TLSIdentity</span><span class="p">.</span><span class="na">getIdentity</span><span class="p">(</span><span class="s">&quot;clientId&quot;</span><span class="p">)</span>
</span><span id="__span-8-4"><a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a><span class="w">        </span><span class="o">?:</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="n">IllegalStateException</span><span class="p">(</span><span class="s">&quot;Cannot find client id&quot;</span><span class="p">)</span>
</span><span id="__span-8-5"><a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a><span class="p">)</span>
</span></code></pre></div>
</div>
<ol>
<li>Get an identity from secure storage and create a <code>TLSIdentity</code> object</li>
<li>Set the authenticator to <a href="/api/couchbase-lite-ee/kotbase/-client-certificate-authenticator/"><code>ClientCertificateAuthenticator</code></a> and configure it to use the retrieved identity</li>
</ol>
<h2 id="initialize-replicator">Initialize Replicator<a class="headerlink" href="#initialize-replicator" title="Permanent link"></a></h2>
<p>Use the <a href="/api/couchbase-lite-ee/kotbase/-replicator/"><code>Replicator</code></a> class’s <a href="/api/couchbase-lite-ee/kotbase/-replicator/-replicator.html"><code>Replicator(ReplicatorConfiguration)</code></a> constructor, to initialize the replicator with the
configuration you have defined. You can, optionally, add a change listener (see <a href="#monitor-sync">Monitor Sync</a>) before
starting the replicator running using <a href="/api/couchbase-lite-ee/kotbase/-replicator/start.html"><code>start()</code></a>.</p>
<div class="admonition example">
<p class="admonition-title">Example 8. Initialize and run replicator</p>
<div class="language-kotlin highlight"><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="c1">// Create replicator</span>
</span><span id="__span-9-2"><a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a><span class="c1">// Consider holding a reference somewhere</span>
</span><span id="__span-9-3"><a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a><span class="c1">// to prevent the Replicator from being GCed</span>
</span><span id="__span-9-4"><a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a><span class="kd">val</span><span class="w"> </span><span class="nv">repl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Replicator</span><span class="p">(</span>
</span><span id="__span-9-5"><a id="__codelineno-9-5" name="__codelineno-9-5" href="#__codelineno-9-5"></a><span class="w">    </span><span class="c1">// initialize the replicator configuration</span>
</span><span id="__span-9-6"><a id="__codelineno-9-6" name="__codelineno-9-6" href="#__codelineno-9-6"></a><span class="w">    </span><span class="n">ReplicatorConfigurationFactory</span><span class="p">.</span><span class="na">newConfig</span><span class="p">(</span>
</span><span id="__span-9-7"><a id="__codelineno-9-7" name="__codelineno-9-7" href="#__codelineno-9-7"></a><span class="w">        </span><span class="n">database</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">database</span><span class="p">,</span>
</span><span id="__span-9-8"><a id="__codelineno-9-8" name="__codelineno-9-8" href="#__codelineno-9-8"></a>
</span><span id="__span-9-9"><a id="__codelineno-9-9" name="__codelineno-9-9" href="#__codelineno-9-9"></a><span class="w">        </span><span class="n">target</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">URLEndpoint</span><span class="p">(</span><span class="s">&quot;wss://listener.com:8954&quot;</span><span class="p">),</span><span class="w"> </span>
</span><span id="__span-9-10"><a id="__codelineno-9-10" name="__codelineno-9-10" href="#__codelineno-9-10"></a>
</span><span id="__span-9-11"><a id="__codelineno-9-11" name="__codelineno-9-11" href="#__codelineno-9-11"></a><span class="w">        </span><span class="c1">// Set replicator type</span>
</span><span id="__span-9-12"><a id="__codelineno-9-12" name="__codelineno-9-12" href="#__codelineno-9-12"></a><span class="w">        </span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ReplicatorType</span><span class="p">.</span><span class="na">PUSH_AND_PULL</span><span class="p">,</span>
</span><span id="__span-9-13"><a id="__codelineno-9-13" name="__codelineno-9-13" href="#__codelineno-9-13"></a>
</span><span id="__span-9-14"><a id="__codelineno-9-14" name="__codelineno-9-14" href="#__codelineno-9-14"></a><span class="w">        </span><span class="c1">// Configure Sync Mode</span>
</span><span id="__span-9-15"><a id="__codelineno-9-15" name="__codelineno-9-15" href="#__codelineno-9-15"></a><span class="w">        </span><span class="n">continuous</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="c1">// default value</span>
</span><span id="__span-9-16"><a id="__codelineno-9-16" name="__codelineno-9-16" href="#__codelineno-9-16"></a>
</span><span id="__span-9-17"><a id="__codelineno-9-17" name="__codelineno-9-17" href="#__codelineno-9-17"></a><span class="w">        </span><span class="c1">// set auto-purge behavior</span>
</span><span id="__span-9-18"><a id="__codelineno-9-18" name="__codelineno-9-18" href="#__codelineno-9-18"></a><span class="w">        </span><span class="c1">// (here we override default)</span>
</span><span id="__span-9-19"><a id="__codelineno-9-19" name="__codelineno-9-19" href="#__codelineno-9-19"></a><span class="w">        </span><span class="n">enableAutoPurge</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span>
</span><span id="__span-9-20"><a id="__codelineno-9-20" name="__codelineno-9-20" href="#__codelineno-9-20"></a>
</span><span id="__span-9-21"><a id="__codelineno-9-21" name="__codelineno-9-21" href="#__codelineno-9-21"></a><span class="w">        </span><span class="c1">// Configure Server Authentication --</span>
</span><span id="__span-9-22"><a id="__codelineno-9-22" name="__codelineno-9-22" href="#__codelineno-9-22"></a><span class="w">        </span><span class="c1">// only accept self-signed certs</span>
</span><span id="__span-9-23"><a id="__codelineno-9-23" name="__codelineno-9-23" href="#__codelineno-9-23"></a><span class="w">        </span><span class="n">acceptOnlySelfSignedServerCertificate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
</span><span id="__span-9-24"><a id="__codelineno-9-24" name="__codelineno-9-24" href="#__codelineno-9-24"></a>
</span><span id="__span-9-25"><a id="__codelineno-9-25" name="__codelineno-9-25" href="#__codelineno-9-25"></a><span class="w">        </span><span class="c1">// Configure the credentials the</span>
</span><span id="__span-9-26"><a id="__codelineno-9-26" name="__codelineno-9-26" href="#__codelineno-9-26"></a><span class="w">        </span><span class="c1">// client will provide if prompted</span>
</span><span id="__span-9-27"><a id="__codelineno-9-27" name="__codelineno-9-27" href="#__codelineno-9-27"></a><span class="w">        </span><span class="n">authenticator</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BasicAuthenticator</span><span class="p">(</span><span class="s">&quot;PRIVUSER&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;let me in&quot;</span><span class="p">.</span><span class="na">toCharArray</span><span class="p">())</span>
</span><span id="__span-9-28"><a id="__codelineno-9-28" name="__codelineno-9-28" href="#__codelineno-9-28"></a><span class="w">    </span><span class="p">)</span>
</span><span id="__span-9-29"><a id="__codelineno-9-29" name="__codelineno-9-29" href="#__codelineno-9-29"></a><span class="p">)</span>
</span><span id="__span-9-30"><a id="__codelineno-9-30" name="__codelineno-9-30" href="#__codelineno-9-30"></a>
</span><span id="__span-9-31"><a id="__codelineno-9-31" name="__codelineno-9-31" href="#__codelineno-9-31"></a><span class="c1">// Start replicator</span>
</span><span id="__span-9-32"><a id="__codelineno-9-32" name="__codelineno-9-32" href="#__codelineno-9-32"></a><span class="n">repl</span><span class="p">.</span><span class="na">start</span><span class="p">(</span><span class="kc">false</span><span class="p">)</span>
</span><span id="__span-9-33"><a id="__codelineno-9-33" name="__codelineno-9-33" href="#__codelineno-9-33"></a>
</span><span id="__span-9-34"><a id="__codelineno-9-34" name="__codelineno-9-34" href="#__codelineno-9-34"></a><span class="k">this</span><span class="p">.</span><span class="na">replicator</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">repl</span>
</span><span id="__span-9-35"><a id="__codelineno-9-35" name="__codelineno-9-35" href="#__codelineno-9-35"></a><span class="k">this</span><span class="p">.</span><span class="na">token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">token</span>
</span></code></pre></div>
</div>
<ol>
<li>Initialize the replicator with the configuration</li>
<li>Start the replicator</li>
</ol>
<h2 id="monitor-sync">Monitor Sync<a class="headerlink" href="#monitor-sync" title="Permanent link"></a></h2>
<p><strong>In this section</strong><br />
<a href="#change-listeners">Change Listeners</a> | <a href="#replicator-status">Replicator Status</a> | <a href="#documents-pending-push">Documents Pending Push
</a></p>
<p>You can monitor a replication’s status by using a combination of <a href="#change-listeners">Change Listeners</a> and the
<code>replicator.status.activityLevel</code> property — see<a href="/api/couchbase-lite-ee/kotbase/-replicator-status/activity-level.html"><code>activityLevel</code></a>. This enables you to know, for example, when the
replication is actively transferring data and when it has stopped.</p>
<h3 id="change-listeners">Change Listeners<a class="headerlink" href="#change-listeners" title="Permanent link"></a></h3>
<p>Use this to monitor changes and to inform on sync progress; this is an optional step. You can add a replicator change
listener at any point; it will report changes from the point it is registered.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Don’t forget to save the token so you can remove the listener later</p>
</div>
<p>Use the <a href="/api/couchbase-lite-ee/kotbase/-replicator/"><code>Replicator</code></a> class to add a change listener as a callback with
<a href="/api/couchbase-lite-ee/kotbase/-replicator/add-change-listener.html"><code>Replicator.addChangeListener()</code></a> — see <a href="#example-9">Example 9
</a>. You will then be asynchronously notified of state changes.</p>
<p>You can remove a change listener with <a href="/api/couchbase-lite-ee/kotbase/-replicator/remove-change-listener.html"><code>removeChangeListener(ListenerToken)</code></a>.</p>
<h4 id="using-kotlin-flows">Using Kotlin Flows<a class="headerlink" href="#using-kotlin-flows" title="Permanent link"></a></h4>
<p>Kotlin developers can take advantage of <code>Flow</code>s to monitor replicators.</p>
<div class="language-kotlin highlight"><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="kd">fun</span><span class="w"> </span><span class="nf">replChangeFlowExample</span><span class="p">(</span><span class="n">repl</span><span class="p">:</span><span class="w"> </span><span class="n">Replicator</span><span class="p">):</span><span class="w"> </span><span class="n">Flow</span><span class="o">&lt;</span><span class="n">ReplicatorActivityLevel</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-10-2"><a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">repl</span><span class="p">.</span><span class="na">replicatorChangesFlow</span><span class="p">()</span>
</span><span id="__span-10-3"><a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a><span class="w">        </span><span class="p">.</span><span class="na">map</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nb">it</span><span class="p">.</span><span class="na">status</span><span class="p">.</span><span class="na">activityLevel</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-10-4"><a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a><span class="p">}</span>
</span></code></pre></div>
<h3 id="replicator-status">Replicator Status<a class="headerlink" href="#replicator-status" title="Permanent link"></a></h3>
<p>You can use the <a href="/api/couchbase-lite-ee/kotbase/-replicator-status/"><code>ReplicatorStatus</code></a> class to check the replicator
status. That is, whether it is actively transferring data or if it has stopped — see <a href="#example-9">Example 9</a>.</p>
<p>The returned <code>ReplicatorStatus</code> structure comprises:</p>
<ul>
<li><a href="/api/couchbase-lite-ee/kotbase/-replicator-status/activity-level.html"><code>activityLevel</code></a> — <code>STOPPED</code>, <code>OFFLINE</code>,
  <code>CONNECTING</code>, <code>IDLE</code>, or <code>BUSY</code> — see states described in <a href="#table-2">Table 2</a></li>
<li><a href="/api/couchbase-lite-ee/kotbase/-replicator-status/progress.html"><code>progress</code></a><ul>
<li><code>completed</code> — the total number of changes completed</li>
<li><code>total</code> — the total number of changes to be processed</li>
</ul>
</li>
<li><a href="/api/couchbase-lite-ee/kotbase/-replicator-status/error.html"><code>error</code></a> — the current error, if any</li>
</ul>
<div class="admonition example">
<p class="admonition-title"><span id='example-9'>Example 9. Monitor replication</span></p>
<div class="tabbed-set tabbed-alternate" data-tabs="2:2"><input checked="checked" id="__tabbed_2_1" name="__tabbed_2" type="radio" /><input id="__tabbed_2_2" name="__tabbed_2" type="radio" /><div class="tabbed-labels"><label for="__tabbed_2_1">Adding a Change Listener</label><label for="__tabbed_2_2">Using replicator.status</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="language-kotlin highlight"><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a><span class="kd">val</span><span class="w"> </span><span class="nv">token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">repl</span><span class="p">.</span><span class="na">addChangeListener</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">change</span><span class="w"> </span><span class="o">-&gt;</span>
</span><span id="__span-11-2"><a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a><span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">err</span><span class="p">:</span><span class="w"> </span><span class="n">CouchbaseLiteException? </span><span class="o">=</span><span class="w"> </span><span class="n">change</span><span class="p">.</span><span class="na">status</span><span class="p">.</span><span class="na">error</span>
</span><span id="__span-11-3"><a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-11-4"><a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a><span class="w">        </span><span class="n">println</span><span class="p">(</span><span class="s">&quot;Error code :: </span><span class="si">${</span><span class="n">err</span><span class="p">.</span><span class="na">code</span><span class="si">}</span><span class="s">\n</span><span class="si">$</span><span class="n">err</span><span class="s">&quot;</span><span class="p">)</span>
</span><span id="__span-11-5"><a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-11-6"><a id="__codelineno-11-6" name="__codelineno-11-6" href="#__codelineno-11-6"></a><span class="p">}</span>
</span></code></pre></div>
</div>
<div class="tabbed-block">
<div class="language-kotlin highlight"><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="n">repl</span><span class="p">.</span><span class="na">status</span><span class="p">.</span><span class="na">let</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-12-2"><a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a><span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">progress</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">it</span><span class="p">.</span><span class="na">progress</span>
</span><span id="__span-12-3"><a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a><span class="w">    </span><span class="n">println</span><span class="p">(</span>
</span><span id="__span-12-4"><a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a><span class="w">        </span><span class="s">&quot;The Replicator is </span><span class="si">${</span>
</span><span id="__span-12-5"><a id="__codelineno-12-5" name="__codelineno-12-5" href="#__codelineno-12-5"></a><span class="w">            </span><span class="nb">it</span><span class="p">.</span><span class="na">activityLevel</span>
</span><span id="__span-12-6"><a id="__codelineno-12-6" name="__codelineno-12-6" href="#__codelineno-12-6"></a><span class="w">        </span><span class="si">}</span><span class="s"> and has processed </span><span class="si">${</span>
</span><span id="__span-12-7"><a id="__codelineno-12-7" name="__codelineno-12-7" href="#__codelineno-12-7"></a><span class="w">            </span><span class="n">progress</span><span class="p">.</span><span class="na">completed</span>
</span><span id="__span-12-8"><a id="__codelineno-12-8" name="__codelineno-12-8" href="#__codelineno-12-8"></a><span class="w">        </span><span class="si">}</span><span class="s"> of </span><span class="si">${</span><span class="n">progress</span><span class="p">.</span><span class="na">total</span><span class="si">}</span><span class="s"> changes&quot;</span>
</span><span id="__span-12-9"><a id="__codelineno-12-9" name="__codelineno-12-9" href="#__codelineno-12-9"></a><span class="w">    </span><span class="p">)</span>
</span><span id="__span-12-10"><a id="__codelineno-12-10" name="__codelineno-12-10" href="#__codelineno-12-10"></a><span class="p">}</span>
</span></code></pre></div>
</div>
</div>
</div>
</div>
<h4 id="replication-states">Replication States<a class="headerlink" href="#replication-states" title="Permanent link"></a></h4>
<p><a href="#table-2">Table 2</a> shows the different states, or activity levels, reported in the API; and the meaning of each.</p>
<p><span id='table-2'><strong>Table 2. Replicator activity levels</strong></span></p>
<table>
<thead>
<tr>
<th style="text-align: center;"><div style="min-width:79px">State</div></th>
<th style="text-align: left;">Meaning</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><code>STOPPED</code></td>
<td style="text-align: left;">The replication is finished or hit a fatal error.</td>
</tr>
<tr>
<td style="text-align: center;"><code>OFFLINE</code></td>
<td style="text-align: left;">The replicator is offline as the remote host is unreachable.</td>
</tr>
<tr>
<td style="text-align: center;"><code>CONNECTING</code></td>
<td style="text-align: left;">The replicator is connecting to the remote host.</td>
</tr>
<tr>
<td style="text-align: center;"><code>IDLE</code></td>
<td style="text-align: left;">The replication caught up with all the changes available from the server. The <code>IDLE</code> state is only used in continuous replications.</td>
</tr>
<tr>
<td style="text-align: center;"><code>BUSY</code></td>
<td style="text-align: left;">The replication is actively transferring data.</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The replication change object also has properties to track the progress (<code>change.status.completed</code> and
<code>change.status.total</code>). Since the replication occurs in batches the total count can vary through the course of a
replication.</p>
</div>
<h4 id="replication-status-and-app-life-cycle">Replication Status and App Life Cycle<a class="headerlink" href="#replication-status-and-app-life-cycle" title="Permanent link"></a></h4>
<h5 id="ios">iOS<a class="headerlink" href="#ios" title="Permanent link"></a></h5>
<p>The following diagram describes the status changes when the application starts a replication, and when the application
is being backgrounded or foregrounded by the OS. It applies to iOS only.</p>
<p><img alt="iOS Replicator States" loading="lazy" src="../assets/images/ios-replicator-states.png" /></p>
<p>Additionally, on iOS, an app already in the background may be terminated. In this case, the <code>Database</code> and <code>Replicator</code>
instances will be <code>null</code> when the app returns to the foreground. Therefore, as preventive measure, it is recommended to
do a <code>null</code> check when the app enters the foreground, and to re-initialize the database and replicator if any of those
are <code>null</code>.</p>
<p>On other platforms, Couchbase Lite doesn’t react to OS backgrounding or foregrounding events and replication(s) will
continue running as long as the remote system does not terminate the connection and the app does not terminate. It is
generally recommended to stop replications before going into the background otherwise socket connections may be closed
by the OS and this may interfere with the replication process.</p>
<h5 id="other-platforms">Other Platforms<a class="headerlink" href="#other-platforms" title="Permanent link"></a></h5>
<p>Couchbase Lite replications will continue running until the app terminates, unless the remote system, or the
application, terminates the connection.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Recall that the Android OS may kill an application without warning. You should explicitly stop replication processes
when they are no longer useful (for example, when the app is in the background and the replication is <code>IDLE</code>) to
avoid socket connections being closed by the OS, which may interfere with the replication process.</p>
</div>
<h3 id="documents-pending-push">Documents Pending Push<a class="headerlink" href="#documents-pending-push" title="Permanent link"></a></h3>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p><a href="/api/couchbase-lite-ee/kotbase/-replicator/is-document-pending.html"><code>Replicator.isDocumentPending()</code></a> is quicker
and more efficient. Use it in preference to returning a list of pending document IDs, where possible.</p>
</div>
<p>You can check whether documents are waiting to be pushed in any forthcoming sync by using either of the following API
methods:</p>
<ul>
<li>Use the <a href="/api/couchbase-lite-ee/kotbase/-replicator/get-pending-document-ids.html"><code>Replicator.getPendingDocumentIds()</code></a> method, which returns a list of document IDs
  that have local changes, but which have not yet been pushed to the server.<br><br>
  This can be very useful in tracking the progress of a push sync, enabling the app to provide a visual indicator to the
  end user on its status, or decide when it is safe to exit.</li>
<li>Use the <a href="/api/couchbase-lite-ee/kotbase/-replicator/is-document-pending.html"><code>Replicator.isDocumentPending()</code></a> method
  to quickly check whether an individual document is pending a push.</li>
</ul>
<div class="admonition example">
<p class="admonition-title">Example 10. Use Pending Document ID API</p>
<div class="language-kotlin highlight"><pre><span></span><code><span id="__span-13-1"><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a><span class="kd">val</span><span class="w"> </span><span class="nv">repl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Replicator</span><span class="p">(</span>
</span><span id="__span-13-2"><a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a><span class="w">    </span><span class="n">ReplicatorConfigurationFactory</span><span class="p">.</span><span class="na">newConfig</span><span class="p">(</span>
</span><span id="__span-13-3"><a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a><span class="w">        </span><span class="n">database</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">database</span><span class="p">,</span>
</span><span id="__span-13-4"><a id="__codelineno-13-4" name="__codelineno-13-4" href="#__codelineno-13-4"></a><span class="w">        </span><span class="n">target</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">URLEndpoint</span><span class="p">(</span><span class="s">&quot;ws://localhost:4984/mydatabase&quot;</span><span class="p">),</span>
</span><span id="__span-13-5"><a id="__codelineno-13-5" name="__codelineno-13-5" href="#__codelineno-13-5"></a><span class="w">        </span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ReplicatorType</span><span class="p">.</span><span class="na">PUSH</span>
</span><span id="__span-13-6"><a id="__codelineno-13-6" name="__codelineno-13-6" href="#__codelineno-13-6"></a><span class="w">    </span><span class="p">)</span>
</span><span id="__span-13-7"><a id="__codelineno-13-7" name="__codelineno-13-7" href="#__codelineno-13-7"></a><span class="p">)</span>
</span><span id="__span-13-8"><a id="__codelineno-13-8" name="__codelineno-13-8" href="#__codelineno-13-8"></a>
</span><span id="__span-13-9"><a id="__codelineno-13-9" name="__codelineno-13-9" href="#__codelineno-13-9"></a><span class="kd">val</span><span class="w"> </span><span class="nv">pendingDocs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">repl</span><span class="p">.</span><span class="na">getPendingDocumentIds</span><span class="p">()</span>
</span><span id="__span-13-10"><a id="__codelineno-13-10" name="__codelineno-13-10" href="#__codelineno-13-10"></a>
</span><span id="__span-13-11"><a id="__codelineno-13-11" name="__codelineno-13-11" href="#__codelineno-13-11"></a><span class="c1">// iterate and report on previously</span>
</span><span id="__span-13-12"><a id="__codelineno-13-12" name="__codelineno-13-12" href="#__codelineno-13-12"></a><span class="c1">// retrieved pending docIds &#39;list&#39;</span>
</span><span id="__span-13-13"><a id="__codelineno-13-13" name="__codelineno-13-13" href="#__codelineno-13-13"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pendingDocs</span><span class="p">.</span><span class="na">isNotEmpty</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-13-14"><a id="__codelineno-13-14" name="__codelineno-13-14" href="#__codelineno-13-14"></a><span class="w">    </span><span class="n">println</span><span class="p">(</span><span class="s">&quot;There are </span><span class="si">${</span><span class="n">pendingDocs</span><span class="p">.</span><span class="na">size</span><span class="si">}</span><span class="s"> documents pending&quot;</span><span class="p">)</span>
</span><span id="__span-13-15"><a id="__codelineno-13-15" name="__codelineno-13-15" href="#__codelineno-13-15"></a>
</span><span id="__span-13-16"><a id="__codelineno-13-16" name="__codelineno-13-16" href="#__codelineno-13-16"></a><span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">firstDoc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pendingDocs</span><span class="p">.</span><span class="na">first</span><span class="p">()</span>
</span><span id="__span-13-17"><a id="__codelineno-13-17" name="__codelineno-13-17" href="#__codelineno-13-17"></a><span class="w">    </span><span class="n">repl</span><span class="p">.</span><span class="na">addChangeListener</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">change</span><span class="w"> </span><span class="o">-&gt;</span>
</span><span id="__span-13-18"><a id="__codelineno-13-18" name="__codelineno-13-18" href="#__codelineno-13-18"></a><span class="w">        </span><span class="n">println</span><span class="p">(</span><span class="s">&quot;Replicator activity level is </span><span class="si">${</span><span class="n">change</span><span class="p">.</span><span class="na">status</span><span class="p">.</span><span class="na">activityLevel</span><span class="si">}</span><span class="s">&quot;</span><span class="p">)</span>
</span><span id="__span-13-19"><a id="__codelineno-13-19" name="__codelineno-13-19" href="#__codelineno-13-19"></a><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-13-20"><a id="__codelineno-13-20" name="__codelineno-13-20" href="#__codelineno-13-20"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">repl</span><span class="p">.</span><span class="na">isDocumentPending</span><span class="p">(</span><span class="n">firstDoc</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-13-21"><a id="__codelineno-13-21" name="__codelineno-13-21" href="#__codelineno-13-21"></a><span class="w">                </span><span class="n">println</span><span class="p">(</span><span class="s">&quot;Doc ID </span><span class="si">$</span><span class="n">firstDoc</span><span class="s"> has been pushed&quot;</span><span class="p">)</span>
</span><span id="__span-13-22"><a id="__codelineno-13-22" name="__codelineno-13-22" href="#__codelineno-13-22"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-13-23"><a id="__codelineno-13-23" name="__codelineno-13-23" href="#__codelineno-13-23"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">err</span><span class="p">:</span><span class="w"> </span><span class="n">CouchbaseLiteException</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-13-24"><a id="__codelineno-13-24" name="__codelineno-13-24" href="#__codelineno-13-24"></a><span class="w">            </span><span class="n">println</span><span class="p">(</span><span class="s">&quot;Failed getting pending docs\n</span><span class="si">$</span><span class="n">err</span><span class="s">&quot;</span><span class="p">)</span>
</span><span id="__span-13-25"><a id="__codelineno-13-25" name="__codelineno-13-25" href="#__codelineno-13-25"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-13-26"><a id="__codelineno-13-26" name="__codelineno-13-26" href="#__codelineno-13-26"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-13-27"><a id="__codelineno-13-27" name="__codelineno-13-27" href="#__codelineno-13-27"></a>
</span><span id="__span-13-28"><a id="__codelineno-13-28" name="__codelineno-13-28" href="#__codelineno-13-28"></a><span class="w">    </span><span class="n">repl</span><span class="p">.</span><span class="na">start</span><span class="p">()</span>
</span><span id="__span-13-29"><a id="__codelineno-13-29" name="__codelineno-13-29" href="#__codelineno-13-29"></a><span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="na">replicator</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">repl</span>
</span><span id="__span-13-30"><a id="__codelineno-13-30" name="__codelineno-13-30" href="#__codelineno-13-30"></a><span class="p">}</span>
</span></code></pre></div>
</div>
<ol>
<li><a href="/api/couchbase-lite-ee/kotbase/-replicator/get-pending-document-ids.html"><code>Replicator.getPendingDocumentIds()</code></a>
   returns a list of the document IDs for all documents waiting to be pushed. This is a snapshot and may have changed by
   the time the response is received and processed.</li>
<li><a href="/api/couchbase-lite-ee/kotbase/-replicator/is-document-pending.html"><code>Replicator.isDocumentPending()</code></a> returns
   <code>true</code> if the document is waiting to be pushed, and <code>false</code> otherwise.</li>
</ol>
<h2 id="stop-sync">Stop Sync<a class="headerlink" href="#stop-sync" title="Permanent link"></a></h2>
<p>Stopping a replication is straightforward. It is done using <a href="/api/couchbase-lite-ee/kotbase/-replicator/stop.html"><code>stop()</code></a>. This initiates an asynchronous operation and so is not
necessarily immediate. Your app should account for this potential delay before attempting any subsequent operations.</p>
<p>You can find further information on database operations in <a href="../databases/">Databases</a>.</p>
<div class="admonition example">
<p class="admonition-title">Example 11. Stop replicator</p>
<div class="language-kotlin highlight"><pre><span></span><code><span id="__span-14-1"><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a><span class="c1">// Stop replication.</span>
</span><span id="__span-14-2"><a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a><span class="n">repl</span><span class="p">.</span><span class="na">stop</span><span class="p">()</span>
</span></code></pre></div>
</div>
<p>Here we initiate the stopping of the replication using the <a href="/api/couchbase-lite-ee/kotbase/-replicator/stop.html"><code>stop()</code></a> method. It will stop any active <a href="#change-listeners">change listener
</a> once the replication is stopped.</p>
<h2 id="conflict-resolution">Conflict Resolution<a class="headerlink" href="#conflict-resolution" title="Permanent link"></a></h2>
<p>Unless you specify otherwise, Couchbase Lite’s default conflict resolution policy is applied — see <a href="../handling-data-conflicts/">Handling Data
Conflicts</a>.</p>
<p>To use a different policy, specify a <em>conflict resolver</em> using <a href="/api/couchbase-lite-ee/kotbase/-replicator-configuration/conflict-resolver.html"><code>conflictResolver</code></a> as shown in <a href="#example-12">Example 12</a>.</p>
<p>For more complex solutions you can provide a custom conflict resolver - see <a href="../handling-data-conflicts/">Handling Data Conflicts</a>.</p>
<div class="admonition example">
<p class="admonition-title"><span id='example-12'>Example 12. Using conflict resolvers</span></p>
<div class="tabbed-set tabbed-alternate" data-tabs="3:3"><input checked="checked" id="__tabbed_3_1" name="__tabbed_3" type="radio" /><input id="__tabbed_3_2" name="__tabbed_3" type="radio" /><input id="__tabbed_3_3" name="__tabbed_3" type="radio" /><div class="tabbed-labels"><label for="__tabbed_3_1">Local Wins</label><label for="__tabbed_3_2">Remote Wins</label><label for="__tabbed_3_3">Merge</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="language-kotlin highlight"><pre><span></span><code><span id="__span-15-1"><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a><span class="kd">val</span><span class="w"> </span><span class="nv">localWinsResolver</span><span class="p">:</span><span class="w"> </span><span class="n">ConflictResolver</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">conflict</span><span class="w"> </span><span class="o">-&gt;</span>
</span><span id="__span-15-2"><a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a><span class="w">    </span><span class="n">conflict</span><span class="p">.</span><span class="na">localDocument</span>
</span><span id="__span-15-3"><a id="__codelineno-15-3" name="__codelineno-15-3" href="#__codelineno-15-3"></a><span class="p">}</span>
</span><span id="__span-15-4"><a id="__codelineno-15-4" name="__codelineno-15-4" href="#__codelineno-15-4"></a><span class="n">config</span><span class="p">.</span><span class="na">conflictResolver</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">localWinsResolver</span>
</span></code></pre></div>
</div>
<div class="tabbed-block">
<div class="language-kotlin highlight"><pre><span></span><code><span id="__span-16-1"><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a><span class="kd">val</span><span class="w"> </span><span class="nv">remoteWinsResolver</span><span class="p">:</span><span class="w"> </span><span class="n">ConflictResolver</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">conflict</span><span class="w"> </span><span class="o">-&gt;</span>
</span><span id="__span-16-2"><a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a><span class="w">    </span><span class="n">conflict</span><span class="p">.</span><span class="na">remoteDocument</span>
</span><span id="__span-16-3"><a id="__codelineno-16-3" name="__codelineno-16-3" href="#__codelineno-16-3"></a><span class="p">}</span>
</span><span id="__span-16-4"><a id="__codelineno-16-4" name="__codelineno-16-4" href="#__codelineno-16-4"></a><span class="n">config</span><span class="p">.</span><span class="na">conflictResolver</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">remoteWinsResolver</span>
</span></code></pre></div>
</div>
<div class="tabbed-block">
<div class="language-kotlin highlight"><pre><span></span><code><span id="__span-17-1"><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a><span class="kd">val</span><span class="w"> </span><span class="nv">mergeConflictResolver</span><span class="p">:</span><span class="w"> </span><span class="n">ConflictResolver</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">conflict</span><span class="w"> </span><span class="o">-&gt;</span>
</span><span id="__span-17-2"><a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a><span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">localDoc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">conflict</span><span class="p">.</span><span class="na">localDocument</span><span class="o">?.</span><span class="na">toMap</span><span class="p">()</span><span class="o">?.</span><span class="na">toMutableMap</span><span class="p">()</span>
</span><span id="__span-17-3"><a id="__codelineno-17-3" name="__codelineno-17-3" href="#__codelineno-17-3"></a><span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">remoteDoc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">conflict</span><span class="p">.</span><span class="na">remoteDocument</span><span class="o">?.</span><span class="na">toMap</span><span class="p">()</span><span class="o">?.</span><span class="na">toMutableMap</span><span class="p">()</span>
</span><span id="__span-17-4"><a id="__codelineno-17-4" name="__codelineno-17-4" href="#__codelineno-17-4"></a>
</span><span id="__span-17-5"><a id="__codelineno-17-5" name="__codelineno-17-5" href="#__codelineno-17-5"></a><span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">merge</span><span class="p">:</span><span class="w"> </span><span class="n">MutableMap</span><span class="o">&lt;</span><span class="kt">String</span><span class="p">,</span><span class="w"> </span><span class="kt">Any?</span><span class="o">&gt;?</span>
</span><span id="__span-17-6"><a id="__codelineno-17-6" name="__codelineno-17-6" href="#__codelineno-17-6"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">localDoc</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-17-7"><a id="__codelineno-17-7" name="__codelineno-17-7" href="#__codelineno-17-7"></a><span class="w">        </span><span class="n">merge</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">remoteDoc</span>
</span><span id="__span-17-8"><a id="__codelineno-17-8" name="__codelineno-17-8" href="#__codelineno-17-8"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-17-9"><a id="__codelineno-17-9" name="__codelineno-17-9" href="#__codelineno-17-9"></a><span class="w">        </span><span class="n">merge</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">localDoc</span>
</span><span id="__span-17-10"><a id="__codelineno-17-10" name="__codelineno-17-10" href="#__codelineno-17-10"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">remoteDoc</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-17-11"><a id="__codelineno-17-11" name="__codelineno-17-11" href="#__codelineno-17-11"></a><span class="w">            </span><span class="n">merge</span><span class="p">.</span><span class="na">putAll</span><span class="p">(</span><span class="n">remoteDoc</span><span class="p">)</span>
</span><span id="__span-17-12"><a id="__codelineno-17-12" name="__codelineno-17-12" href="#__codelineno-17-12"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-17-13"><a id="__codelineno-17-13" name="__codelineno-17-13" href="#__codelineno-17-13"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-17-14"><a id="__codelineno-17-14" name="__codelineno-17-14" href="#__codelineno-17-14"></a>
</span><span id="__span-17-15"><a id="__codelineno-17-15" name="__codelineno-17-15" href="#__codelineno-17-15"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">merge</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-17-16"><a id="__codelineno-17-16" name="__codelineno-17-16" href="#__codelineno-17-16"></a><span class="w">        </span><span class="n">MutableDocument</span><span class="p">(</span><span class="n">conflict</span><span class="p">.</span><span class="na">documentId</span><span class="p">)</span>
</span><span id="__span-17-17"><a id="__codelineno-17-17" name="__codelineno-17-17" href="#__codelineno-17-17"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-17-18"><a id="__codelineno-17-18" name="__codelineno-17-18" href="#__codelineno-17-18"></a><span class="w">        </span><span class="n">MutableDocument</span><span class="p">(</span><span class="n">conflict</span><span class="p">.</span><span class="na">documentId</span><span class="p">,</span><span class="w"> </span><span class="n">merge</span><span class="p">)</span>
</span><span id="__span-17-19"><a id="__codelineno-17-19" name="__codelineno-17-19" href="#__codelineno-17-19"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-17-20"><a id="__codelineno-17-20" name="__codelineno-17-20" href="#__codelineno-17-20"></a><span class="p">}</span>
</span><span id="__span-17-21"><a id="__codelineno-17-21" name="__codelineno-17-21" href="#__codelineno-17-21"></a><span class="n">config</span><span class="p">.</span><span class="na">conflictResolver</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mergeConflictResolver</span>
</span></code></pre></div>
</div>
</div>
</div>
</div>
<p>Just as a replicator may observe a conflict — when updating a document that has changed both in the local database and
in a remote database — any attempt to save a document may also observe a conflict, if a replication has taken place
since the local app retrieved the document from the database. To address that possibility, a version of the
<a href="/api/couchbase-lite-ee/kotbase/-database/save.html"><code>Database.save()</code></a> method also takes a conflict resolver as shown
in <a href="#example-13">Example 13</a>.</p>
<p>The following code snippet shows an example of merging properties from the existing document (<code>curDoc</code>) into the one
being saved (<code>newDoc</code>). In the event of conflicting keys, it will pick the key value from <code>newDoc</code>.</p>
<div class="admonition example">
<p class="admonition-title"><span id='example-13'>Example 13. Merging document properties</span></p>
<div class="language-kotlin highlight"><pre><span></span><code><span id="__span-18-1"><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a><span class="kd">val</span><span class="w"> </span><span class="nv">mutableDocument</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">database</span><span class="p">.</span><span class="na">getDocument</span><span class="p">(</span><span class="s">&quot;xyz&quot;</span><span class="p">)</span><span class="o">?.</span><span class="na">toMutable</span><span class="p">()</span><span class="w"> </span><span class="o">?:</span><span class="w"> </span><span class="k">return</span>
</span><span id="__span-18-2"><a id="__codelineno-18-2" name="__codelineno-18-2" href="#__codelineno-18-2"></a><span class="n">mutableDocument</span><span class="p">.</span><span class="na">setString</span><span class="p">(</span><span class="s">&quot;name&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;apples&quot;</span><span class="p">)</span>
</span><span id="__span-18-3"><a id="__codelineno-18-3" name="__codelineno-18-3" href="#__codelineno-18-3"></a><span class="n">database</span><span class="p">.</span><span class="na">save</span><span class="p">(</span><span class="n">mutableDocument</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">newDoc</span><span class="p">,</span><span class="w"> </span><span class="n">curDoc</span><span class="w"> </span><span class="o">-&gt;</span>
</span><span id="__span-18-4"><a id="__codelineno-18-4" name="__codelineno-18-4" href="#__codelineno-18-4"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">curDoc</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-18-5"><a id="__codelineno-18-5" name="__codelineno-18-5" href="#__codelineno-18-5"></a><span class="w">        </span><span class="k">return</span><span class="nd">@save</span><span class="w"> </span><span class="kc">false</span>
</span><span id="__span-18-6"><a id="__codelineno-18-6" name="__codelineno-18-6" href="#__codelineno-18-6"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-18-7"><a id="__codelineno-18-7" name="__codelineno-18-7" href="#__codelineno-18-7"></a><span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">dataMap</span><span class="p">:</span><span class="w"> </span><span class="n">MutableMap</span><span class="o">&lt;</span><span class="kt">String</span><span class="p">,</span><span class="w"> </span><span class="kt">Any?</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">curDoc</span><span class="p">.</span><span class="na">toMap</span><span class="p">().</span><span class="na">toMutableMap</span><span class="p">()</span>
</span><span id="__span-18-8"><a id="__codelineno-18-8" name="__codelineno-18-8" href="#__codelineno-18-8"></a><span class="w">    </span><span class="n">dataMap</span><span class="p">.</span><span class="na">putAll</span><span class="p">(</span><span class="n">newDoc</span><span class="p">.</span><span class="na">toMap</span><span class="p">())</span>
</span><span id="__span-18-9"><a id="__codelineno-18-9" name="__codelineno-18-9" href="#__codelineno-18-9"></a><span class="w">    </span><span class="n">newDoc</span><span class="p">.</span><span class="na">setData</span><span class="p">(</span><span class="n">dataMap</span><span class="p">)</span>
</span><span id="__span-18-10"><a id="__codelineno-18-10" name="__codelineno-18-10" href="#__codelineno-18-10"></a><span class="w">    </span><span class="kc">true</span>
</span><span id="__span-18-11"><a id="__codelineno-18-11" name="__codelineno-18-11" href="#__codelineno-18-11"></a><span class="p">}</span>
</span></code></pre></div>
</div>
<p>For more on replicator conflict resolution see <a href="../handling-data-conflicts/">Handling Data Conflicts</a>.</p>
<h2 id="delta-sync">Delta Sync<a class="headerlink" href="#delta-sync" title="Permanent link"></a></h2>
<p>If delta sync is enabled on the listener, then replication will use delta sync.</p>









  




                
              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var tab,labels=set.querySelector(".tabbed-labels");for(tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
    
      
      <nav class="md-footer__inner md-grid" aria-label="Footer" >
        
          
          <a href="../passive-peer/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Passive Peer">
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Previous
              </span>
              <div class="md-ellipsis">
                Passive Peer
              </div>
            </div>
          </a>
        
        
          
          <a href="../integrate-custom-listener/" class="md-footer__link md-footer__link--next" aria-label="Next: Integrate Custom Listener">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Next
              </span>
              <div class="md-ellipsis">
                Integrate Custom Listener
              </div>
            </div>
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      &copy; 2023 Jeff Lockhart
    </div>
  
  
</div>
      
        <div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://github.com/jeffdgr8" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://twitter.com/jeffdgr8" target="_blank" rel="noopener" title="twitter.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18.901 1.153h3.68l-8.04 9.19L24 22.846h-7.406l-5.8-7.584-6.638 7.584H.474l8.6-9.83L0 1.154h7.594l5.243 6.932ZM17.61 20.644h2.039L6.486 3.24H4.298Z"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://linkedin.com/in/lockhartjeff/" target="_blank" rel="noopener" title="linkedin.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433a2.062 2.062 0 0 1-2.063-2.065 2.064 2.064 0 1 1 2.063 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "..", "features": ["content.code.copy", "content.tabs.link", "navigation.footer", "navigation.instant", "navigation.tabs", "navigation.top", "navigation.tracking", "search.suggest", "toc.follow"], "search": "../assets/javascripts/workers/search.f886a092.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": "3.0.15-1.0.1"}</script>
    
    
      <script src="../assets/javascripts/bundle.d7c377c4.min.js"></script>
      
    
  </body>
</html>